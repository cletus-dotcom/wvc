<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Menu - Catering</title>
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-start mb-3">
        <div>
            <a href="{{ url_for('catering.catering_home') }}" class="btn btn-secondary btn-sm mb-1">&larr; Back</a>
            <h3 class="mb-1">Manage Menu</h3>
        </div>
        <button class="btn btn-warning btn-sm mt-2" data-bs-toggle="modal" data-bs-target="#addMenuItemModal">
            + Add Menu Item
        </button>
    </div>

    <!-- Search Bar -->
    <div class="mb-3">
        <label for="searchMenu" class="form-label">Search Menu</label>
        <input type="text" id="searchMenu" class="form-control" placeholder="Type to search...">
    </div>

    <!-- Menu Table -->
    <div class="card shadow-sm">
        <div class="card-header bg-warning text-dark">
            Food and Beverage
        </div>
        <div class="card-body">
            <table class="table table-bordered table-sm align-middle" id="menuTable">
                <thead class="table-light">
                    <tr>
                        <th>Description</th>
                        <th>Price</th>
                        <th style="width: 150px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                {% for item in menu_items %}
                    <tr id="menuRow{{ item.id }}">
                        <td>{{ item.description }}</td>
                        <td>₱{{ "{:,.2f}".format(item.price) }}</td>
                        <td>
                            <button class="btn btn-warning btn-sm edit-btn"
                                    data-id="{{ item.id }}"
                                    data-description="{{ item.description }}"
                                    data-price="{{ item.price }}">
                                Edit
                            </button>
                            <a href="{{ url_for('catering.delete_menu_item', item_id=item.id) }}"
                               class="btn btn-danger btn-sm delete-btn"
                               onclick="return confirm('Are you sure you want to delete this menu item?');">
                                Delete
                            </a>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Add Menu Item Modal -->
    <div class="modal fade" id="addMenuItemModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="addMenuItemForm">
                    <div class="modal-header">
                        <h5 class="modal-title">Add Menu Item</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <input type="text" name="description" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Price</label>
                            <input type="number" step="0.01" min="0" name="price" class="form-control" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-warning btn-sm">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Menu Item Modal -->
    <div class="modal fade" id="editMenuItemModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="POST" id="editMenuItemForm">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit Menu Item</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <input type="text" name="description" class="form-control" id="editDescription" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Price</label>
                            <input type="number" step="0.01" min="0" name="price" class="form-control" id="editPrice" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-warning btn-sm">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

</div>

<script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
<script>
    // ===================== Menu Table & Modals =====================
    const menuTable = document.querySelector('#menuTable tbody');
    const addForm = document.getElementById('addMenuItemForm');
    const editForm = document.getElementById('editMenuItemForm');
    const editDescription = document.getElementById('editDescription');
    const editPrice = document.getElementById('editPrice');

    // ---------- Add Menu Item ----------
    addForm.addEventListener('submit', e => {
        e.preventDefault();
        const formData = new FormData(addForm);

        fetch('{{ url_for("catering.add_menu_item") }}', {
            method: 'POST',
            headers: {'X-Requested-With': 'XMLHttpRequest'},
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if(data.success){
                addOrUpdateRow(data.menu_item);
                addForm.reset();
                bootstrap.Modal.getInstance(document.getElementById('addMenuItemModal')).hide();
            } else {
                alert(data.error || 'Failed to add menu item.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while adding the menu item.');
        });
    });

    // ---------- Edit Menu Item ----------
    menuTable.parentElement.addEventListener('click', e => {
        if(e.target.classList.contains('edit-btn')){
            const btn = e.target;
            editForm.action = `/catering/edit-menu-item/${btn.dataset.id}`;
            editDescription.value = btn.dataset.description;
            editPrice.value = btn.dataset.price;
            new bootstrap.Modal(document.getElementById('editMenuItemModal')).show();
        }
    });

    editForm.addEventListener('submit', e => {
        e.preventDefault();
        const formData = new FormData(editForm);

        fetch(editForm.action, {
            method: 'POST',
            headers: {'X-Requested-With': 'XMLHttpRequest'},
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if(data.success){
                addOrUpdateRow(data.menu_item);
                bootstrap.Modal.getInstance(document.getElementById('editMenuItemModal')).hide();
            } else {
                alert(data.error || 'Failed to update menu item.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while updating the menu item.');
        });
    });

    // ---------- Add/Update Table Row ----------
    function addOrUpdateRow(item){
        let row = document.getElementById(`menuRow${item.id}`);
        if(!row){
            row = document.createElement('tr');
            row.id = `menuRow${item.id}`;
            menuTable.appendChild(row);
        }
        const priceDisplay = parseFloat(item.price).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        row.innerHTML = `
            <td>${item.description}</td>
            <td>₱${priceDisplay}</td>
            <td>
                <button class="btn btn-warning btn-sm edit-btn"
                        data-id="${item.id}"
                        data-description="${item.description}"
                        data-price="${item.price}">
                    Edit
                </button>
                <a href="/catering/delete-menu-item/${item.id}" class="btn btn-danger btn-sm delete-btn" onclick="return confirm('Are you sure?');">Delete</a>
            </td>
        `;
    }

    // ===================== Live Table Filter =====================
    const searchInput = document.getElementById('searchMenu');
    searchInput.addEventListener('input', function(){
        const query = this.value.toLowerCase();
        menuTable.querySelectorAll('tr').forEach(row => {
            const descriptionCell = row.children[0].textContent.toLowerCase();
            if(descriptionCell.includes(query)){
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });
</script>

</body>
</html>
