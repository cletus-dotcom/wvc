<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Equipment - Catering</title>
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-start mb-3">
        <div>
            <a href="{{ url_for('catering.catering_home') }}" class="btn btn-secondary btn-sm mb-1">&larr; Back</a>
            <h3 class="mb-1">Manage Equipment</h3>
        </div>
        <button class="btn btn-warning btn-sm mt-2" data-bs-toggle="modal" data-bs-target="#addEquipmentModal">
            + Add Equipment
        </button>
    </div>

    <!-- Search Bar -->
    <div class="mb-3">
        <label for="searchEquipment" class="form-label">Search Equipment</label>
        <input type="text" id="searchEquipment" class="form-control" placeholder="Type to search...">
    </div>

    <!-- Equipment Table -->
    <div class="card shadow-sm">
        <div class="card-header bg-warning text-dark">
            Equipment Rentals
        </div>
        <div class="card-body">
            <table class="table table-bordered table-sm align-middle" id="equipmentTable">
                <thead class="table-light">
                    <tr>
                        <th>Description</th>
                        <th>Rent Price</th>
                        <th style="width: 150px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                {% for item in equipment_items %}
                    <tr id="equipmentRow{{ item.id }}">
                        <td>{{ item.description }}</td>
                        <td>₱{{ "{:,.2f}".format(item.rent_price) }}</td>
                        <td>
                            <button class="btn btn-warning btn-sm edit-btn"
                                    data-id="{{ item.id }}"
                                    data-description="{{ item.description }}"
                                    data-rent-price="{{ item.rent_price }}">
                                Edit
                            </button>
                            <a href="{{ url_for('catering.delete_equipment_item', item_id=item.id) }}"
                               class="btn btn-danger btn-sm delete-btn"
                               onclick="return confirm('Are you sure you want to delete this equipment item?');">
                                Delete
                            </a>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Add Equipment Modal -->
    <div class="modal fade" id="addEquipmentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="addEquipmentForm">
                    <div class="modal-header">
                        <h5 class="modal-title">Add Equipment</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <input type="text" name="description" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Rent Price</label>
                            <input type="number" step="0.01" min="0" name="rent_price" class="form-control" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-warning btn-sm">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Equipment Modal -->
    <div class="modal fade" id="editEquipmentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="POST" id="editEquipmentForm">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit Equipment</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <input type="text" name="description" class="form-control" id="editDescription" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Rent Price</label>
                            <input type="number" step="0.01" min="0" name="rent_price" class="form-control" id="editRentPrice" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-warning btn-sm">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

</div>

<script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
<script>
    // ===================== Equipment Table & Modals =====================
    const equipmentTable = document.querySelector('#equipmentTable tbody');
    const addForm = document.getElementById('addEquipmentForm');
    const editForm = document.getElementById('editEquipmentForm');
    const editDescription = document.getElementById('editDescription');
    const editRentPrice = document.getElementById('editRentPrice');

    // ---------- Add Equipment Item ----------
    addForm.addEventListener('submit', e => {
        e.preventDefault();
        const formData = new FormData(addForm);

        fetch('{{ url_for("catering.add_equipment_item") }}', {
            method: 'POST',
            headers: {'X-Requested-With': 'XMLHttpRequest'},
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if(data.success){
                addOrUpdateRow(data.equipment_item);
                addForm.reset();
                bootstrap.Modal.getInstance(document.getElementById('addEquipmentModal')).hide();
            } else {
                alert(data.error || 'Failed to add equipment item.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while adding the equipment item.');
        });
    });

    // ---------- Edit Equipment Item ----------
    equipmentTable.parentElement.addEventListener('click', e => {
        if(e.target.classList.contains('edit-btn')){
            const btn = e.target;
            editForm.action = `/catering/edit-equipment-item/${btn.dataset.id}`;
            editDescription.value = btn.dataset.description;
            editRentPrice.value = btn.dataset.rentPrice;
            new bootstrap.Modal(document.getElementById('editEquipmentModal')).show();
        }
    });

    editForm.addEventListener('submit', e => {
        e.preventDefault();
        const formData = new FormData(editForm);

        fetch(editForm.action, {
            method: 'POST',
            headers: {'X-Requested-With': 'XMLHttpRequest'},
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if(data.success){
                addOrUpdateRow(data.equipment_item);
                bootstrap.Modal.getInstance(document.getElementById('editEquipmentModal')).hide();
            } else {
                alert(data.error || 'Failed to update equipment item.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while updating the equipment item.');
        });
    });

    // ---------- Add/Update Table Row ----------
    function addOrUpdateRow(item){
        let row = document.getElementById(`equipmentRow${item.id}`);
        if(!row){
            row = document.createElement('tr');
            row.id = `equipmentRow${item.id}`;
            equipmentTable.appendChild(row);
        }
        const priceDisplay = parseFloat(item.rent_price).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        row.innerHTML = `
            <td>${item.description}</td>
            <td>₱${priceDisplay}</td>
            <td>
                <button class="btn btn-warning btn-sm edit-btn"
                        data-id="${item.id}"
                        data-description="${item.description}"
                        data-rent-price="${item.rent_price}">
                    Edit
                </button>
                <a href="/catering/delete-equipment-item/${item.id}" class="btn btn-danger btn-sm delete-btn" onclick="return confirm('Are you sure?');">Delete</a>
            </td>
        `;
    }

    // ===================== Live Table Filter =====================
    const searchInput = document.getElementById('searchEquipment');
    searchInput.addEventListener('input', function(){
        const query = this.value.toLowerCase();
        equipmentTable.querySelectorAll('tr').forEach(row => {
            const descriptionCell = row.children[0].textContent.toLowerCase();
            if(descriptionCell.includes(query)){
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });
</script>

</body>
</html>
