{% extends "carenderia/home.html" %}

{% block content %}
<!-- Title Card -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-success text-white">
        <div class="d-flex justify-content-between align-items-center">
            <h3 class="mb-0">View/Edit Transactions</h3>
            <a href="{{ url_for('carenderia.carenderia_home') }}" class="btn btn-light btn-sm">
                ‚Üê Back to Home
            </a>
        </div>
    </div>
</div>

<!-- Date Filter Card -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0">Filter by Date</h5>
    </div>
    <div class="card-body">
        <div class="row g-3 align-items-end">
            <div class="col-md-4">
                <label for="filterDate" class="form-label fw-bold">Select Date</label>
                <input type="date" class="form-control" id="filterDate" name="filter_date">
            </div>
            <div class="col-md-4">
                <button type="button" class="btn btn-success" id="loadTransactionsBtn">Load Transactions</button>
                <button type="button" class="btn btn-secondary" id="clearFilterBtn">Clear</button>
            </div>
        </div>
    </div>
</div>

<!-- Transactions Table Card -->
<div class="card shadow-sm">
    <div class="card-header bg-success text-white">
        <h5 class="mb-0">Transactions</h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-bordered table-sm align-middle mb-0" style="font-size: 0.85rem;">
                <thead style="position: sticky; top: 0; z-index: 100; background-color: #d1e7dd;">
                    <tr>
                        <th style="background-color: #d1e7dd;">Date</th>
                        <th style="background-color: #d1e7dd;">Type</th>
                        <th style="background-color: #d1e7dd;">Amount</th>
                        <th style="background-color: #d1e7dd;">Actions</th>
                    </tr>
                </thead>
                <tbody id="transactionsTableBody">
                    <tr>
                        <td colspan="4" class="text-center text-muted py-4">Select a date and click "Load Transactions" to view transactions.</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Running Balance Card -->
<div class="card mt-4 shadow-sm">
    <div class="card-header bg-success text-white">
        <h5 class="mb-0">Running Balance</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center p-2 bg-light rounded">
                        <span class="fw-bold">Daily Collection</span>
                        <span class="fw-bold" id="runningDailyCollection">0.00</span>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <h6 class="fw-bold mb-3">Deductions:</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered mb-0">
                        <tbody>
                            <tr id="rowDeductionWages">
                                <td class="fw-bold">Wages</td>
                                <td class="text-end" id="deductionWages">0.00</td>
                            </tr>
                            <tr id="rowDeductionElectricBill">
                                <td class="fw-bold">Electric Bill</td>
                                <td class="text-end" id="deductionElectricBill">0.00</td>
                            </tr>
                            <tr id="rowDeductionWaterBill">
                                <td class="fw-bold">Water Bill</td>
                                <td class="text-end" id="deductionWaterBill">0.00</td>
                            </tr>
                            <tr id="rowDeductionMaintenance">
                                <td class="fw-bold">Maintenance</td>
                                <td class="text-end" id="deductionMaintenance">0.00</td>
                            </tr>
                            <tr id="rowDeductionMayorsPermit">
                                <td class="fw-bold">Mayor's Permit</td>
                                <td class="text-end" id="deductionMayorsPermit">0.00</td>
                            </tr>
                            <tr id="rowDeductionRental">
                                <td class="fw-bold">Rental</td>
                                <td class="text-end" id="deductionRental">0.00</td>
                            </tr>
                            <tr id="rowDeductionBIR">
                                <td class="fw-bold">BIR</td>
                                <td class="text-end" id="deductionBIR">0.00</td>
                            </tr>
                            <tr id="rowDeductionSSS">
                                <td class="fw-bold">SSS</td>
                                <td class="text-end" id="deductionSSS">0.00</td>
                            </tr>
                            <tr id="rowDeductionPAGIBIG">
                                <td class="fw-bold">PAG-IBIG</td>
                                <td class="text-end" id="deductionPAGIBIG">0.00</td>
                            </tr>
                            <tr id="rowDeductionPurchases">
                                <td class="fw-bold">Purchases</td>
                                <td class="text-end" id="deductionPurchases">0.00</td>
                            </tr>
                            <tr class="table-secondary">
                                <td class="fw-bold">Total Deductions</td>
                                <td class="text-end fw-bold" id="runningTotalDeductions">0.00</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center p-3 bg-warning text-dark rounded">
                    <span class="fw-bold fs-5">Total Amount (Daily Collection - Deductions)</span>
                    <span class="fw-bold fs-5" id="runningNetAmount">0.00</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Transaction Modal -->
<div class="modal fade" id="editTransactionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="editTransactionForm">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Transaction</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editTransactionId" name="transaction_id">
                    <div class="mb-3">
                        <label for="editDate" class="form-label fw-bold">DATE</label>
                        <input type="date" class="form-control" id="editDate" name="date" required>
                    </div>
                    <div class="mb-3">
                        <label for="editTransactionType" class="form-label fw-bold">Type of Transaction</label>
                        <select class="form-select" id="editTransactionType" name="transaction_type" required>
                            <option value="">Select Type</option>
                            <option value="Wages">Wages</option>
                            <option value="Electric Bill">Electric Bill</option>
                            <option value="Water Bill">Water Bill</option>
                            <option value="Maintenance">Maintenance</option>
                            <option value="Mayor's Permit">Mayor's Permit</option>
                            <option value="Rental">Rental</option>
                            <option value="BIR">BIR</option>
                            <option value="SSS">SSS</option>
                            <option value="PAG-IBIG">PAG-IBIG</option>
                            <option value="Purchases">Purchases</option>
                            <option value="Daily Sales">Daily Sales</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editAmount" class="form-label fw-bold">Amount</label>
                        <input type="number" step="0.01" class="form-control" id="editAmount" name="amount" placeholder="0.00" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    let loadedTransactions = [];

    // Helper function to format numbers with commas
    function formatAmount(num) {
        return parseFloat(num || 0).toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }

    // Load transactions for selected date
    document.getElementById('loadTransactionsBtn').addEventListener('click', async function() {
        const filterDate = document.getElementById('filterDate').value;
        
        if (!filterDate) {
            alert('Please select a date.');
            return;
        }

        try {
            const resp = await fetch(`{{ url_for("carenderia.get_transactions_by_date") }}?date=${filterDate}`);
            const data = await resp.json();
            
            if (resp.ok && data.success) {
                loadedTransactions = data.transactions || [];
                updateTransactionsTable();
                updateRunningBalance();
            } else {
                alert(data.error || 'Failed to load transactions.');
            }
        } catch (error) {
            console.error(error);
            alert('Error loading transactions. Please try again.');
        }
    });

    // Clear filter
    document.getElementById('clearFilterBtn').addEventListener('click', function() {
        document.getElementById('filterDate').value = '';
        loadedTransactions = [];
        updateTransactionsTable();
        updateRunningBalance();
    });

    // Update transactions table
    function updateTransactionsTable() {
        const tbody = document.getElementById('transactionsTableBody');
        tbody.innerHTML = '';

        if (loadedTransactions.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-4">No transactions found for the selected date.</td></tr>';
            return;
        }

        loadedTransactions.forEach(trans => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${new Date(trans.date).toLocaleDateString()}</td>
                <td>${trans.trans_type}</td>
                <td class="fw-bold text-end">${formatAmount(trans.amount)}</td>
                <td class="text-center">
                    <button class="btn btn-sm btn-warning edit-transaction-btn me-1" data-id="${trans.id}">Edit</button>
                    <button class="btn btn-sm btn-danger delete-transaction-btn" data-id="${trans.id}">Delete</button>
                </td>
            `;
            tbody.appendChild(row);
        });

        // Add edit event listeners
        document.querySelectorAll('.edit-transaction-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const id = parseInt(this.getAttribute('data-id'));
                const transaction = loadedTransactions.find(t => t.id === id);
                if (transaction) {
                    document.getElementById('editTransactionId').value = transaction.id;
                    document.getElementById('editDate').value = transaction.date;
                    document.getElementById('editTransactionType').value = transaction.trans_type;
                    document.getElementById('editAmount').value = parseFloat(transaction.amount).toFixed(2);
                    new bootstrap.Modal(document.getElementById('editTransactionModal')).show();
                }
            });
        });

        // Add delete event listeners
        document.querySelectorAll('.delete-transaction-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                if (!confirm('Are you sure you want to delete this transaction?')) {
                    return;
                }

                const id = parseInt(this.getAttribute('data-id'));
                
                try {
                    const deleteUrl = '{{ url_for("carenderia.delete_transaction", trans_id=0) }}'.replace('/0', `/${id}`);
                    const resp = await fetch(deleteUrl, {
                        method: 'DELETE'
                    });
                    const data = await resp.json();
                    
                    if (resp.ok && data.success) {
                        loadedTransactions = loadedTransactions.filter(t => t.id !== id);
                        updateTransactionsTable();
                        updateRunningBalance();
                        alert('Transaction deleted successfully!');
                    } else {
                        alert(data.error || 'Failed to delete transaction.');
                    }
                } catch (error) {
                    console.error(error);
                    alert('Error deleting transaction. Please try again.');
                }
            });
        });
    }

    // Handle edit form submission
    document.getElementById('editTransactionForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const transId = document.getElementById('editTransactionId').value;
        const entryDate = document.getElementById('editDate').value;
        const transactionType = document.getElementById('editTransactionType').value;
        const amount = parseFloat(document.getElementById('editAmount').value) || 0;
        
        if (!entryDate || !transactionType || amount <= 0) {
            alert('Please fill in all fields correctly.');
            return;
        }

        try {
            const updateUrl = '{{ url_for("carenderia.update_transaction", trans_id=0) }}'.replace('/0', `/${transId}`);
            const resp = await fetch(updateUrl, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    date: entryDate,
                    trans_type: transactionType,
                    amount: amount
                })
            });
            const data = await resp.json();
            
            if (resp.ok && data.success) {
                // Update local transaction
                const transaction = loadedTransactions.find(t => t.id === parseInt(transId));
                if (transaction) {
                    transaction.date = entryDate;
                    transaction.trans_type = transactionType;
                    transaction.amount = amount;
                }
                updateTransactionsTable();
                updateRunningBalance();
                bootstrap.Modal.getInstance(document.getElementById('editTransactionModal')).hide();
                alert('Transaction updated successfully!');
            } else {
                alert(data.error || 'Failed to update transaction.');
            }
        } catch (error) {
            console.error(error);
            alert('Error updating transaction. Please try again.');
        }
    });

    // Update running balance based on loaded transactions
    function updateRunningBalance() {
        // Calculate totals by transaction type
        let dailyCollection = 0;
        let wages = 0;
        let electricBill = 0;
        let waterBill = 0;
        let maintenance = 0;
        let mayorsPermit = 0;
        let rental = 0;
        let bir = 0;
        let sss = 0;
        let pagIbig = 0;
        let purchases = 0;

        loadedTransactions.forEach(trans => {
            const amount = parseFloat(trans.amount) || 0;
            const transType = trans.trans_type || '';

            if (transType === 'Daily Sales') {
                dailyCollection += amount;
            } else if (transType === 'Wages') {
                wages += amount;
            } else if (transType === 'Electric Bill') {
                electricBill += amount;
            } else if (transType === 'Water Bill') {
                waterBill += amount;
            } else if (transType === 'Maintenance') {
                maintenance += amount;
            } else if (transType === "Mayor's Permit") {
                mayorsPermit += amount;
            } else if (transType === 'Rental') {
                rental += amount;
            } else if (transType === 'BIR') {
                bir += amount;
            } else if (transType === 'SSS') {
                sss += amount;
            } else if (transType === 'PAG-IBIG') {
                pagIbig += amount;
            } else if (transType === 'Purchases') {
                purchases += amount;
            }
        });

        const totalDeductions = wages + electricBill + waterBill + maintenance + 
                               mayorsPermit + rental + bir + sss + pagIbig + purchases;
        const netAmount = dailyCollection - totalDeductions;

        // Update display
        document.getElementById('runningDailyCollection').textContent = formatAmount(dailyCollection);
        
        // Update deduction rows (show/hide based on amount)
        updateDeductionRow('rowDeductionWages', 'deductionWages', wages);
        updateDeductionRow('rowDeductionElectricBill', 'deductionElectricBill', electricBill);
        updateDeductionRow('rowDeductionWaterBill', 'deductionWaterBill', waterBill);
        updateDeductionRow('rowDeductionMaintenance', 'deductionMaintenance', maintenance);
        updateDeductionRow('rowDeductionMayorsPermit', 'deductionMayorsPermit', mayorsPermit);
        updateDeductionRow('rowDeductionRental', 'deductionRental', rental);
        updateDeductionRow('rowDeductionBIR', 'deductionBIR', bir);
        updateDeductionRow('rowDeductionSSS', 'deductionSSS', sss);
        updateDeductionRow('rowDeductionPAGIBIG', 'deductionPAGIBIG', pagIbig);
        updateDeductionRow('rowDeductionPurchases', 'deductionPurchases', purchases);
        
        document.getElementById('runningTotalDeductions').textContent = formatAmount(totalDeductions);
        document.getElementById('runningNetAmount').textContent = formatAmount(netAmount);
    }

    // Helper function to update deduction row and show/hide based on amount
    function updateDeductionRow(rowId, amountId, amount) {
        const row = document.getElementById(rowId);
        const amountElement = document.getElementById(amountId);
        
        if (amount > 0) {
            row.style.display = '';
            amountElement.textContent = formatAmount(amount);
        } else {
            row.style.display = 'none';
            amountElement.textContent = formatAmount(0);
        }
    }

    // Initialize running balance display on page load (hide zero rows)
    updateRunningBalance();
</script>
{% endblock %}
