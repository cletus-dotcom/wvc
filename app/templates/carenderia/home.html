<!-- app/templates/carenderia/home.html -->
<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carenderia Home</title>
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
</head>
<style>
    .dropdown-menu .dropdown-item:hover {
        background-color: #d1e7dd !important;
        color: #000 !important;
    }

    .dropdown-item.corporate-item:hover {
        background-color: #198754;
        color: white !important;
    }

    /* Highlight table row on hover */
    .project-row {
        cursor: pointer;
        transition: background-color 0.2s ease-in-out;
    }

    .project-row:hover {
        background-color: rgba(25, 135, 84, 0.12); /* subtle Bootstrap-success tint */
    }

    /* Optional sticky table header */
    thead th {
        position: sticky;
        top: 0;
        background-color: #f8f9fa;
        z-index: 2;
    }

    /* override Bootstrap striped rows */
    .table-striped > tbody > tr.project-row:hover > * {
        background-color: rgba(25, 135, 84, 0.18) !important;
    }

    /* Transaction table styling */
    #transactionsTableBody tr:nth-child(even) {
        background-color: #f8f9fa;
    }

    #transactionsTableBody tr:nth-child(odd) {
        background-color: #e7f3ff;
    }

    #transactionsTableBody tr:hover {
        background-color: rgba(25, 135, 84, 0.1) !important;
    }

    .table-responsive {
        max-height: 500px;
        overflow-y: auto;
    }

    /* Form input styling */
    .form-label {
        font-size: 0.85rem;
    }

    .form-control {
        font-size: 0.9rem;
    }

    /* Summary panel styling */
    .card-body .rounded {
        border: 1px solid rgba(0,0,0,0.1);
    }


</style>

<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-success">
        <div class="container-fluid">

            <!-- LEFT MENU TOGGLER -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                    aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">

                <!-- LEFT NAV ITEMS -->
                <ul class="navbar-nav me-auto">

                    <!-- HOME -->
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'core.dashboard' %}active{% endif %}"
                        href="{{ url_for('core.dashboard') }}">
                            SMBC
                        </a>
                    </li>

                    <!-- SETTINGS -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle fw-bold"
                        href="#" role="button" data-bs-toggle="dropdown">
                            Settings
                        </a>
                        <ul class="dropdown-menu">
                            <li>
                                <a class="dropdown-item" href="{{ url_for('carenderia.manage_employee') }}">
                                    Manage Workers
                                </a>
                            </li>
                        </ul>
                    </li>

                    <!-- CORPORATE (visible only for Corporate users or Admin role) -->
                    {% if session.get('department') == 'Corporate' or session.get('role') == 'Admin' %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle fw-bold
                            {% if request.endpoint in ['carenderia.manage_department', 'carenderia.view_transactions', 'carenderia.monthly_trial_balance', 'carenderia.view_wages_report', 'carenderia.export_trial_balance'] %}active{% endif %}"
                        href="#" id="corporateDropdown" role="button"
                        data-bs-toggle="dropdown">
                            Corporate
                        </a>

                        <ul class="dropdown-menu" aria-labelledby="corporateDropdown">

                            <!-- Manage Department -->
                            <li>
                                <a class="dropdown-item"
                                href="{{ url_for('carenderia.manage_department') }}">
                                    Manage Department
                                </a>
                            </li>

                            <li><hr class="dropdown-divider"></li>

                            <!-- View Transactions Per Date -->
                            <li>
                                <a class="dropdown-item"
                                href="{{ url_for('carenderia.view_transactions') }}">
                                    View Transactions Per Date
                                </a>
                            </li>

                            <!-- Monthly Trial Balance Sheet -->
                            <li>
                                <a class="dropdown-item"
                                href="{{ url_for('carenderia.monthly_trial_balance') }}">
                                    Monthly Trial Balance Sheet
                                </a>
                            </li>

                            <!-- View Wages Report -->
                            <li>
                                <a class="dropdown-item"
                                href="{{ url_for('carenderia.view_wages_report') }}">
                                    View Wages Report
                                </a>
                            </li>

                            <li><hr class="dropdown-divider"></li>

                            <!-- Export Trial Balance -->
                            <li>
                                <a class="dropdown-item"
                                href="{{ url_for('carenderia.export_trial_balance') }}">
                                    Export Trial Balance
                                </a>
                            </li>

                        </ul>
                    </li>
                    {% endif %}



                    <!-- LOGOUT -->
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('auth.logout') }}">Logout</a>
                    </li>

                </ul>

                <!-- RIGHT-SIDE TITLE + LOGO -->
                <span class="navbar-text fw-bold text-white d-flex align-items-center">
                    Carenderia
                    <img src="{{ url_for('static', filename='images/wvc_logo.png') }}"
                        alt="WVC Logo"
                        style="height: 28px; width: auto; margin-left: 10px;">
                </span>

            </div>
        </div>
    </nav>


    <!-- Main Content -->
    <div class="container mt-4">
        {% block content %}
        <!-- Welcome Alert Card -->
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <h4 class="alert-heading mb-2">Welcome, {{ session.get('username', 'User') }}!</h4>
            <p class="mb-0">Carenderia Department Dashboard</p>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <!-- Entry Form Card -->
        <div class="card mt-4 shadow-sm">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">Entry Form</h5>
            </div>
            <div class="card-body">
                <form id="entryForm">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-3">
                            <label for="entryDate" class="form-label fw-bold">DATE</label>
                            <input type="date" class="form-control" id="entryDate" name="date" required>
                        </div>
                        <div class="col-md-4">
                            <label for="transactionType" class="form-label fw-bold">Type of Transaction</label>
                            <select class="form-select" id="transactionType" name="transaction_type" required>
                                <option value="">Select Type</option>
                                <option value="Wages">Wages</option>
                                <option value="Electric Bill">Electric Bill</option>
                                <option value="Water Bill">Water Bill</option>
                                <option value="Maintenance">Maintenance</option>
                                <option value="Mayor's Permit">Mayor's Permit</option>
                                <option value="Rental">Rental</option>
                                <option value="BIR">BIR</option>
                                <option value="SSS">SSS</option>
                                <option value="PAG-IBIG">PAG-IBIG</option>
                                <option value="Purchases">Purchases</option>
                                <option value="Daily Sales">Daily Sales</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="amount" class="form-label fw-bold">Amount</label>
                            <input type="number" step="0.01" class="form-control" id="amount" name="amount" placeholder="0.00" required>
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-success w-100">Save Entry</button>
                            <button type="reset" class="btn btn-secondary w-100 mt-2" id="clearFormBtn">Clear</button>
                        </div>
                    </div>
                    <!-- Hidden fields for Wages transaction -->
                    <div class="row g-3 mt-2" id="wagesFields" style="display: none;">
                        <div class="col-md-8">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="wagesEmployee" class="form-label fw-bold">Employee</label>
                                    <select class="form-select" id="wagesEmployee" name="wages_employee">
                                        <option value="">Select Employee</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="wagesRatePerDay" class="form-label fw-bold">Rate per Day</label>
                                    <input type="number" step="0.01" class="form-control" id="wagesRatePerDay" name="wages_rate_per_day" placeholder="0.00" readonly>
                                </div>
                                <div class="col-md-3">
                                    <label for="wagesDays" class="form-label fw-bold">Number of Days</label>
                                    <input type="number" step="0.01" class="form-control" id="wagesDays" name="wages_days" placeholder="0" min="0">
                                </div>
                            </div>
                            <div class="row g-3 mt-2">
                                <div class="col-md-6">
                                    <label for="wagesTotalAmount" class="form-label fw-bold">Total Amount</label>
                                    <input type="number" step="0.01" class="form-control" id="wagesTotalAmount" name="wages_total_amount" placeholder="0.00" readonly>
                                </div>
                                <div class="col-md-6 d-flex align-items-end">
                                    <button type="button" class="btn btn-success w-100" id="addWagesEmployeeBtn">Add Employee</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0">Wages Entries</h6>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive" style="max-height: 300px;">
                                        <table class="table table-sm table-bordered mb-0">
                                            <thead style="position: sticky; top: 0; background-color: #d1e7dd; z-index: 10;">
                                                <tr>
                                                    <th style="background-color: #d1e7dd;">Date</th>
                                                    <th style="background-color: #d1e7dd;">Employee</th>
                                                    <th style="background-color: #d1e7dd;">Total Amount</th>
                                                    <th style="background-color: #d1e7dd;">Action</th>
                                                </tr>
                                            </thead>
                                            <tbody id="wagesEntriesTableBody">
                                                <tr>
                                                    <td colspan="4" class="text-center text-muted py-2" style="font-size: 0.85rem;">No entries yet</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="card-footer bg-light">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <strong>Grand Total:</strong>
                                            <strong id="wagesGrandTotal">0.00</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Transactions Table -->
        <div class="card mt-4 shadow-sm">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Transaction Records</h5>
                <button type="button" class="btn btn-light btn-sm" id="submitTransactionsBtn">
                    Submit Transaction
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-bordered table-sm align-middle mb-0" style="font-size: 0.85rem;">
                        <thead style="position: sticky; top: 0; z-index: 100; background-color: #d1e7dd;">
                            <tr>
                                <th style="background-color: #d1e7dd;">DATE</th>
                                <th style="background-color: #d1e7dd;">Type</th>
                                <th style="background-color: #d1e7dd;">Amount</th>
                                <th style="background-color: #d1e7dd;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsTableBody">
                            <!-- Table rows will be populated here -->
                            <tr>
                                <td colspan="4" class="text-center text-muted py-4">No transactions yet. Add an entry above.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Running Balance Card -->
        <div class="card mt-4 shadow-sm">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">Running Balance</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center p-2 bg-light rounded">
                                <span class="fw-bold">Daily Collection</span>
                                <span class="fw-bold" id="runningDailyCollection">0.00</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="fw-bold mb-3">Deductions:</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered mb-0">
                                <tbody>
                                    <tr id="rowDeductionWages">
                                        <td class="fw-bold">Wages</td>
                                        <td class="text-end" id="deductionWages">0.00</td>
                                    </tr>
                                    <tr id="rowDeductionElectricBill">
                                        <td class="fw-bold">Electric Bill</td>
                                        <td class="text-end" id="deductionElectricBill">0.00</td>
                                    </tr>
                                    <tr id="rowDeductionWaterBill">
                                        <td class="fw-bold">Water Bill</td>
                                        <td class="text-end" id="deductionWaterBill">0.00</td>
                                    </tr>
                                    <tr id="rowDeductionMaintenance">
                                        <td class="fw-bold">Maintenance</td>
                                        <td class="text-end" id="deductionMaintenance">0.00</td>
                                    </tr>
                                    <tr id="rowDeductionMayorsPermit">
                                        <td class="fw-bold">Mayor's Permit</td>
                                        <td class="text-end" id="deductionMayorsPermit">0.00</td>
                                    </tr>
                                    <tr id="rowDeductionRental">
                                        <td class="fw-bold">Rental</td>
                                        <td class="text-end" id="deductionRental">0.00</td>
                                    </tr>
                                    <tr id="rowDeductionBIR">
                                        <td class="fw-bold">BIR</td>
                                        <td class="text-end" id="deductionBIR">0.00</td>
                                    </tr>
                                    <tr id="rowDeductionSSS">
                                        <td class="fw-bold">SSS</td>
                                        <td class="text-end" id="deductionSSS">0.00</td>
                                    </tr>
                                    <tr id="rowDeductionPAGIBIG">
                                        <td class="fw-bold">PAG-IBIG</td>
                                        <td class="text-end" id="deductionPAGIBIG">0.00</td>
                                    </tr>
                                    <tr id="rowDeductionPurchases">
                                        <td class="fw-bold">Purchases</td>
                                        <td class="text-end" id="deductionPurchases">0.00</td>
                                    </tr>
                                    <tr class="table-secondary">
                                        <td class="fw-bold">Total Deductions</td>
                                        <td class="text-end fw-bold" id="runningTotalDeductions">0.00</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center p-3 bg-warning text-dark rounded">
                            <span class="fw-bold fs-5">Total Amount (Daily Collection - Deductions)</span>
                            <span class="fw-bold fs-5" id="runningNetAmount">0.00</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Transaction Modal -->
        <div class="modal fade" id="editTransactionModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form id="editTransactionForm">
                        <div class="modal-header">
                            <h5 class="modal-title">Edit Transaction</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="editDate" class="form-label fw-bold">DATE</label>
                                <input type="date" class="form-control" id="editDate" name="date" required>
                            </div>
                            <div class="mb-3">
                                <label for="editTransactionType" class="form-label fw-bold">Type of Transaction</label>
                                <select class="form-select" id="editTransactionType" name="transaction_type" required>
                                    <option value="">Select Type</option>
                                    <option value="Wages">Wages</option>
                                    <option value="Electric Bill">Electric Bill</option>
                                    <option value="Water Bill">Water Bill</option>
                                    <option value="Maintenance">Maintenance</option>
                                    <option value="Mayor's Permit">Mayor's Permit</option>
                                    <option value="Rental">Rental</option>
                                    <option value="BIR">BIR</option>
                                    <option value="SSS">SSS</option>
                                    <option value="PAG-IBIG">PAG-IBIG</option>
                                    <option value="Purchases">Purchases</option>
                                    <option value="Daily Sales">Daily Sales</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="editAmount" class="form-label fw-bold">Amount</label>
                                <input type="number" step="0.01" class="form-control" id="editAmount" name="amount" placeholder="0.00" required>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-success">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        {% endblock %}
    </div>


    {% block scripts %}
    <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
    <script>
        // Store transactions in memory (will be replaced with backend later)
        let transactions = [];
        let carenderiaEmployees = [];
        let wagesEntries = []; // Store individual employee wage entries

        // Helper function to format numbers with commas
        function formatAmount(num) {
            return parseFloat(num || 0).toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        // Load Carenderia employees
        async function loadCarenderiaEmployees() {
            try {
                const response = await fetch('{{ url_for("carenderia.get_carenderia_employees") }}');
                const data = await response.json();
                carenderiaEmployees = data.employees || [];
                
                // Populate employee dropdown
                const employeeSelect = document.getElementById('wagesEmployee');
                employeeSelect.innerHTML = '<option value="">Select Employee</option>';
                carenderiaEmployees.forEach(emp => {
                    const option = document.createElement('option');
                    option.value = emp.id;
                    option.textContent = emp.name;
                    option.setAttribute('data-rate', emp.rate_per_day || 0);
                    option.setAttribute('data-dept-id', emp.department_id || '');
                    option.setAttribute('data-role', emp.role || '');
                    employeeSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading employees:', error);
            }
        }

        // Show/hide wages fields based on transaction type
        document.getElementById('transactionType').addEventListener('change', function() {
            const wagesFields = document.getElementById('wagesFields');
            const amountField = document.getElementById('amount');
            
            if (this.value === 'Wages') {
                wagesFields.style.display = 'block';
                amountField.readOnly = true;
                amountField.value = '';
                loadCarenderiaEmployees();
            } else {
                wagesFields.style.display = 'none';
                amountField.readOnly = false;
                // Clear wages input fields but keep entries in memory
                document.getElementById('wagesEmployee').value = '';
                document.getElementById('wagesRatePerDay').value = '';
                document.getElementById('wagesDays').value = '';
                document.getElementById('wagesTotalAmount').value = '';
                amountField.value = '';
                // Note: wagesEntries are NOT cleared here - they persist until Submit Transaction
            }
        });

        // Auto-fill rate per day when employee is selected
        document.getElementById('wagesEmployee').addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const ratePerDay = selectedOption.getAttribute('data-rate') || 0;
            document.getElementById('wagesRatePerDay').value = formatAmount(ratePerDay);
            calculateWagesTotal();
        });

        // Auto-calculate total amount when days or rate changes
        document.getElementById('wagesDays').addEventListener('input', calculateWagesTotal);
        document.getElementById('wagesRatePerDay').addEventListener('input', calculateWagesTotal);

        function calculateWagesTotal() {
            const ratePerDay = parseFloat(document.getElementById('wagesRatePerDay').value) || 0;
            const days = parseFloat(document.getElementById('wagesDays').value) || 0;
            const totalAmount = ratePerDay * days;
            
            document.getElementById('wagesTotalAmount').value = formatAmount(totalAmount);
            updateWagesGrandTotal();
        }

        // Add employee to wages entries
        document.getElementById('addWagesEmployeeBtn').addEventListener('click', function() {
            const entryDate = document.getElementById('entryDate').value;
            const employeeSelect = document.getElementById('wagesEmployee');
            const employeeId = employeeSelect.value;
            const employeeName = employeeSelect.options[employeeSelect.selectedIndex].text;
            const employeeDeptId = employeeSelect.options[employeeSelect.selectedIndex].getAttribute('data-dept-id') || null;
            const employeeRole = employeeSelect.options[employeeSelect.selectedIndex].getAttribute('data-role') || null;
            const ratePerDay = parseFloat(document.getElementById('wagesRatePerDay').value) || 0;
            const days = parseFloat(document.getElementById('wagesDays').value) || 0;
            
            if (!entryDate) {
                alert('Please select a date first.');
                return;
            }
            
            if (!employeeId) {
                alert('Please select an employee.');
                return;
            }
            
            if (days <= 0) {
                alert('Please enter a valid number of days.');
                return;
            }
            
            // Check if employee already exists
            const existingIndex = wagesEntries.findIndex(e => e.employeeId === parseInt(employeeId));
            const totalAmount = ratePerDay * days;
            
            if (existingIndex >= 0) {
                // Update existing entry
                wagesEntries[existingIndex].ratePerDay = ratePerDay;
                wagesEntries[existingIndex].days = days;
                wagesEntries[existingIndex].totalAmount = totalAmount;
                wagesEntries[existingIndex].departmentId = employeeDeptId ? parseInt(employeeDeptId) : null;
                wagesEntries[existingIndex].employeeRole = employeeRole;
                wagesEntries[existingIndex].date = entryDate;
            } else {
                // Add new entry
                wagesEntries.push({
                    id: wagesEntries.length > 0 ? Math.max(...wagesEntries.map(e => e.id)) + 1 : 1,
                    employeeId: parseInt(employeeId),
                    employeeName: employeeName,
                    departmentId: employeeDeptId ? parseInt(employeeDeptId) : null,
                    employeeRole: employeeRole,
                    ratePerDay: ratePerDay,
                    days: days,
                    totalAmount: totalAmount,
                    date: entryDate
                });
            }
            
            updateWagesEntriesTable();
            
            // Clear form fields
            employeeSelect.value = '';
            document.getElementById('wagesRatePerDay').value = '';
            document.getElementById('wagesDays').value = '';
            document.getElementById('wagesTotalAmount').value = '';
        });

        // Update wages entries table
        function updateWagesEntriesTable() {
            const tbody = document.getElementById('wagesEntriesTableBody');
            tbody.innerHTML = '';
            
            if (wagesEntries.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-2" style="font-size: 0.85rem;">No entries yet</td></tr>';
                updateWagesGrandTotal();
                return;
            }
            
            wagesEntries.forEach(entry => {
                const row = document.createElement('tr');
                const dateDisplay = entry.date ? new Date(entry.date).toLocaleDateString() : 'N/A';
                row.innerHTML = `
                    <td>${dateDisplay}</td>
                    <td>${entry.employeeName}</td>
                    <td class="text-end">${formatAmount(entry.totalAmount)}</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-danger delete-wages-entry" data-id="${entry.id}">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Add delete event listeners
            document.querySelectorAll('.delete-wages-entry').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    wagesEntries = wagesEntries.filter(e => e.id !== id);
                    updateWagesEntriesTable();
                });
            });
            
            updateWagesGrandTotal();
        }

        // Update grand total for wages
        function updateWagesGrandTotal() {
            const grandTotal = wagesEntries.reduce((sum, entry) => sum + entry.totalAmount, 0);
            document.getElementById('wagesGrandTotal').textContent = formatAmount(grandTotal);
            document.getElementById('amount').value = formatAmount(grandTotal);
        }

        // Define expense types (for calculating cash out)
        const expenseTypes = ['Wages', 'Electric Bill', 'Water Bill', 'Maintenance', 'Mayor\'s Permit', 'Rental', 'BIR', 'SSS', 'PAG-IBIG', 'Purchases'];
        const incomeTypes = ['Daily Sales'];

        // Check if transaction type is an expense
        function isExpense(type) {
            return expenseTypes.includes(type);
        }

        // Check if transaction type is income
        function isIncome(type) {
            return incomeTypes.includes(type);
        }

        // Calculate totals from transactions
        function calculateTotals() {
            let totalExpenses = 0;
            let totalIncome = 0;
            let cashOnHand = 0;

            // Sort transactions by date and id to calculate in order
            const sortedTransactions = [...transactions].sort((a, b) => {
                if (a.date !== b.date) {
                    return new Date(a.date) - new Date(b.date);
                }
                return a.id - b.id;
            });

            sortedTransactions.forEach(trans => {
                const amount = parseFloat(trans.amount) || 0;
                if (isExpense(trans.transactionType)) {
                    totalExpenses += amount;
                    cashOnHand -= amount;
                } else if (isIncome(trans.transactionType)) {
                    totalIncome += amount;
                    cashOnHand += amount;
                }
            });

            return { totalExpenses, totalIncome, cashOnHand };
        }

        // Update running balance
        function updateRunningBalance() {
            // Calculate totals by transaction type
            let dailyCollection = 0;
            let wages = 0;
            let electricBill = 0;
            let waterBill = 0;
            let maintenance = 0;
            let mayorsPermit = 0;
            let rental = 0;
            let bir = 0;
            let sss = 0;
            let pagIbig = 0;
            let purchases = 0;

            transactions.forEach(trans => {
                const amount = parseFloat(trans.amount) || 0;
                const type = trans.transactionType;

                if (type === 'Daily Sales') {
                    dailyCollection += amount;
                } else if (type === 'Wages') {
                    wages += amount;
                } else if (type === 'Electric Bill') {
                    electricBill += amount;
                } else if (type === 'Water Bill') {
                    waterBill += amount;
                } else if (type === 'Maintenance') {
                    maintenance += amount;
                } else if (type === 'Mayor\'s Permit') {
                    mayorsPermit += amount;
                } else if (type === 'Rental') {
                    rental += amount;
                } else if (type === 'BIR') {
                    bir += amount;
                } else if (type === 'SSS') {
                    sss += amount;
                } else if (type === 'PAG-IBIG') {
                    pagIbig += amount;
                } else if (type === 'Purchases') {
                    purchases += amount;
                }
            });

            const totalDeductions = wages + electricBill + waterBill + maintenance + 
                                   mayorsPermit + rental + bir + sss + pagIbig + purchases;
            const netAmount = dailyCollection - totalDeductions;

            // Update running balance display
            document.getElementById('runningDailyCollection').textContent = formatAmount(dailyCollection);
            
            // Update deduction amounts and show/hide rows based on amount
            updateDeductionRow('rowDeductionWages', 'deductionWages', wages);
            updateDeductionRow('rowDeductionElectricBill', 'deductionElectricBill', electricBill);
            updateDeductionRow('rowDeductionWaterBill', 'deductionWaterBill', waterBill);
            updateDeductionRow('rowDeductionMaintenance', 'deductionMaintenance', maintenance);
            updateDeductionRow('rowDeductionMayorsPermit', 'deductionMayorsPermit', mayorsPermit);
            updateDeductionRow('rowDeductionRental', 'deductionRental', rental);
            updateDeductionRow('rowDeductionBIR', 'deductionBIR', bir);
            updateDeductionRow('rowDeductionSSS', 'deductionSSS', sss);
            updateDeductionRow('rowDeductionPAGIBIG', 'deductionPAGIBIG', pagIbig);
            updateDeductionRow('rowDeductionPurchases', 'deductionPurchases', purchases);
            
            document.getElementById('runningTotalDeductions').textContent = formatAmount(totalDeductions);
            document.getElementById('runningNetAmount').textContent = formatAmount(netAmount);
        }

        // Helper function to update deduction row and show/hide based on amount
        function updateDeductionRow(rowId, amountId, amount) {
            const row = document.getElementById(rowId);
            const amountElement = document.getElementById(amountId);
            
            if (amount > 0) {
                row.style.display = '';
                amountElement.textContent = formatAmount(amount);
            } else {
                row.style.display = 'none';
                amountElement.textContent = formatAmount(0);
            }
        }

        // Update summary panels (now only updates running balance)
        function updateSummaryPanels() {
            // Update running balance
            updateRunningBalance();
        }

        // Recalculate cash on hand for all transactions
        function recalculateCashOnHand() {
            let runningCash = 0;
            transactions.forEach(trans => {
                const amount = parseFloat(trans.amount) || 0;
                if (isExpense(trans.transactionType)) {
                    runningCash -= amount;
                } else if (isIncome(trans.transactionType)) {
                    runningCash += amount;
                }
                trans.cashOnHand = runningCash;
            });
        }

        // Handle form submission
        document.getElementById('entryForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const entryDate = document.getElementById('entryDate').value;
            const transactionType = document.getElementById('transactionType').value;
            let amount = parseFloat(document.getElementById('amount').value) || 0;
            
            if (!entryDate) {
                alert('Please select a date.');
                return;
            }

            if (!transactionType) {
                alert('Please select a transaction type.');
                return;
            }

            // Validate wages fields if transaction type is Wages
            if (transactionType === 'Wages') {
                if (wagesEntries.length === 0) {
                    alert('Please add at least one employee wage entry.');
                    return;
                }
                
                // Use grand total from all wages entries
                amount = wagesEntries.reduce((sum, entry) => sum + entry.totalAmount, 0);
            }

            if (amount <= 0) {
                alert('Please enter a valid amount.');
                return;
            }

            // Create transaction object
            const transaction = {
                id: transactions.length > 0 ? Math.max(...transactions.map(t => t.id)) + 1 : 1,
                date: entryDate,
                transactionType: transactionType,
                amount: amount
            };

            transactions.push(transaction);
            recalculateCashOnHand();
            updateTransactionsTable();
            updateSummaryPanels();
            this.reset();
            
            // Reset wages fields visibility
            if (transactionType === 'Wages') {
                // For Wages, hide the fields but keep entries in memory
                document.getElementById('wagesFields').style.display = 'none';
                document.getElementById('amount').readOnly = false;
                // Clear the input fields but keep wagesEntries
                document.getElementById('wagesEmployee').value = '';
                document.getElementById('wagesRatePerDay').value = '';
                document.getElementById('wagesDays').value = '';
                document.getElementById('wagesTotalAmount').value = '';
                // Reset transaction type dropdown
                document.getElementById('transactionType').value = '';
            } else {
                document.getElementById('wagesFields').style.display = 'none';
                document.getElementById('amount').readOnly = false;
            }
        });

        // Handle edit form submission
        let editingTransactionId = null;
        document.getElementById('editTransactionForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!editingTransactionId) return;

            const entryDate = document.getElementById('editDate').value;
            const transactionType = document.getElementById('editTransactionType').value;
            const amount = parseFloat(document.getElementById('editAmount').value) || 0;
            
            if (!entryDate || !transactionType || amount <= 0) {
                alert('Please fill in all fields correctly.');
                return;
            }

            // Find and update transaction
            const transaction = transactions.find(t => t.id === editingTransactionId);
            if (transaction) {
                transaction.date = entryDate;
                transaction.transactionType = transactionType;
                transaction.amount = amount;
                
                recalculateCashOnHand();
                updateTransactionsTable();
                updateSummaryPanels();
                
                bootstrap.Modal.getInstance(document.getElementById('editTransactionModal')).hide();
                editingTransactionId = null;
            }
        });

        // Update transactions table - show each transaction individually
        function updateTransactionsTable() {
            const tbody = document.getElementById('transactionsTableBody');
            tbody.innerHTML = '';

            if (transactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-4">No transactions yet. Add an entry above.</td></tr>';
                return;
            }

            // Sort transactions by date and id
            const sortedTransactions = [...transactions].sort((a, b) => {
                if (a.date !== b.date) {
                    return new Date(a.date) - new Date(b.date);
                }
                return a.id - b.id;
            });

            sortedTransactions.forEach(trans => {
                const amount = parseFloat(trans.amount) || 0;
                const type = trans.transactionType;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${new Date(trans.date).toLocaleDateString()}</td>
                    <td>${type}</td>
                    <td class="fw-bold">${formatAmount(amount)}</td>
                    <td>
                        <button class="btn btn-sm btn-warning edit-transaction me-1" data-id="${trans.id}">Edit</button>
                        <button class="btn btn-sm btn-danger delete-transaction" data-id="${trans.id}">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            // Add edit event listeners
            document.querySelectorAll('.edit-transaction').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    const transaction = transactions.find(t => t.id === id);
                    if (transaction) {
                        editingTransactionId = id;
                        document.getElementById('editDate').value = transaction.date;
                        document.getElementById('editTransactionType').value = transaction.transactionType;
                        document.getElementById('editAmount').value = transaction.amount;
                        new bootstrap.Modal(document.getElementById('editTransactionModal')).show();
                    }
                });
            });

            // Add delete event listeners
            document.querySelectorAll('.delete-transaction').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (confirm('Are you sure you want to delete this transaction?')) {
                        const id = parseInt(this.getAttribute('data-id'));
                        transactions = transactions.filter(t => t.id !== id);
                        recalculateCashOnHand();
                        updateTransactionsTable();
                        updateSummaryPanels();
                    }
                });
            });
        }

        // Handle form reset
        document.getElementById('clearFormBtn').addEventListener('click', function() {
            const transactionType = document.getElementById('transactionType').value;
            if (transactionType === 'Wages') {
                // For Wages, just clear input fields but keep entries
                document.getElementById('wagesEmployee').value = '';
                document.getElementById('wagesRatePerDay').value = '';
                document.getElementById('wagesDays').value = '';
                document.getElementById('wagesTotalAmount').value = '';
            } else {
                document.getElementById('wagesFields').style.display = 'none';
                document.getElementById('amount').readOnly = false;
                document.getElementById('wagesEmployee').value = '';
                document.getElementById('wagesRatePerDay').value = '';
                document.getElementById('wagesDays').value = '';
                document.getElementById('wagesTotalAmount').value = '';
            }
            // Note: wagesEntries are NOT cleared on form reset - they persist until Submit Transaction
        });

        // Handle Submit Transaction button
        document.getElementById('submitTransactionsBtn').addEventListener('click', async function() {
            if (transactions.length === 0) {
                alert('No transactions to submit.');
                return;
            }

            // Collect all wages entries from all Wages transactions
            const allWagesEntries = [];
            const wagesTransactions = transactions.filter(t => t.transactionType === 'Wages');
            
            if (wagesTransactions.length > 0 && wagesEntries.length > 0) {
                // Get the date from the first Wages transaction
                const wagesDate = wagesTransactions[0].date;
                
                // Save wages entries to backend
                try {
                    const wagesResp = await fetch('{{ url_for("carenderia.save_wages") }}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            date: wagesDate,
                            entries: wagesEntries
                        })
                    });
                    const wagesData = await wagesResp.json();
                    if (!wagesResp.ok || !wagesData.success) {
                        alert(wagesData.error || 'Failed to save wages.');
                        return;
                    }
                } catch (error) {
                    console.error(error);
                    alert('Error saving wages. Please try again.');
                    return;
                }
            }

            if (!confirm(`Are you sure you want to submit ${transactions.length} transaction(s) to the database?`)) {
                return;
            }

            try {
                const resp = await fetch('{{ url_for("carenderia.save_transactions") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        transactions: transactions
                    })
                });
                const data = await resp.json();
                
                if (resp.ok && data.success) {
                    alert(data.message || 'Transactions saved successfully!');
                    // Clear transactions and wages entries after successful save
                    transactions = [];
                    wagesEntries = [];
                    updateTransactionsTable();
                    updateWagesEntriesTable();
                    updateSummaryPanels();
                } else {
                    alert(data.error || 'Failed to save transactions.');
                }
            } catch (error) {
                console.error(error);
                alert('Error saving transactions. Please try again.');
            }
        });

        // Initialize
        updateSummaryPanels();
        
        // Load employees on page load
        loadCarenderiaEmployees();
    </script>
    {% endblock %}
</body>
</html>
