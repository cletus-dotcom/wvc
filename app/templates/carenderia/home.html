<!-- app/templates/carenderia/home.html -->
<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Carenderia Home</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='images/wvc_logo.ico') }}">
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/mobile-friendly.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<style>
    :root {
        --pastel-entry: #fce4ec;
        --pastel-transactions: #e3f2fd;
        --pastel-trial: #e8f5e9;
        --pastel-wages: #fff3e0;
        --card-radius: 12px;
        --shadow-sm: 0 2px 8px rgba(0,0,0,0.06);
        --shadow-md: 0 4px 16px rgba(0,0,0,0.08);
    }

    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: linear-gradient(160deg, #faf5f5 0%, #f5efef 100%);
        min-height: 100vh;
        color: #1e293b;
    }

    .dropdown-menu .dropdown-item:hover {
        background-color: #fce4ec !important;
        color: #000 !important;
    }

    .dropdown-item.corporate-item:hover {
        background-color: #dc3545;
        color: white !important;
    }

    .project-row {
        cursor: pointer;
        transition: background-color 0.2s ease;
    }

    .project-row:hover {
        background-color: rgba(220, 53, 69, 0.08) !important;
    }

    .table-striped > tbody > tr.project-row:hover > * {
        background-color: rgba(220, 53, 69, 0.1) !important;
    }

    thead th {
        position: sticky;
        top: 0;
        background: #f8fafc !important;
        z-index: 2;
    }

    #transactionsTableBody tr:nth-child(even) {
        background-color: #fafafa;
    }

    #transactionsTableBody tr:nth-child(odd) {
        background-color: #fff;
    }

    #transactionsTableBody tr:hover {
        background-color: rgba(220, 53, 69, 0.06) !important;
    }

    .purchases-expandable:hover {
        background-color: rgba(220, 53, 69, 0.08) !important;
    }

    .purchases-items-row td { border-top: none !important; }
    .wages-expandable:hover {
        background-color: rgba(220, 53, 69, 0.08) !important;
    }
    .wages-items-row td { border-top: none !important; }

    #purchasesItemsTableBody .purchase-desc { min-width: 200px; }
    .table-responsive { max-height: 500px; overflow-y: auto; }
    .form-label { font-size: 0.85rem; }
    .form-control { font-size: 0.9rem; }
    .card-body .rounded { border: 1px solid rgba(0,0,0,0.08); }

    /* Dashboard header + pastel status cards */
    .dashboard-header {
        display: flex;
        flex-wrap: wrap;
        align-items: flex-start;
        gap: 1.5rem;
        margin-bottom: 1.75rem;
    }

    .dashboard-welcome h1 {
        font-weight: 700;
        font-size: 1.75rem;
        color: #1e293b;
        letter-spacing: -0.02em;
        margin-bottom: 0.25rem;
    }

    .dashboard-welcome .text-muted {
        font-size: 0.95rem;
        color: #64748b !important;
    }

    .dashboard-cards {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        align-items: stretch;
    }

    .dash-card {
        display: block;
        border: none;
        border-radius: var(--card-radius);
        padding: 1rem 1.25rem;
        text-align: center;
        box-shadow: var(--shadow-sm);
        transition: box-shadow 0.2s ease, transform 0.2s ease;
        text-decoration: none;
        color: inherit;
        min-width: 120px;
    }

    .dash-card:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
        color: inherit;
    }

    .dash-card.dash-card-main {
        min-width: 130px;
        padding: 1.25rem 1.5rem;
        background: var(--pastel-entry) !important;
    }

    .dash-card.dash-card-transactions { background: var(--pastel-transactions) !important; }
    .dash-card.dash-card-trial { background: var(--pastel-trial) !important; }
    .dash-card.dash-card-wages { background: var(--pastel-wages) !important; }

    .dash-card .dash-card-title {
        font-size: 0.85rem;
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 0.2rem;
    }

    .dash-card .dash-card-desc {
        font-size: 0.75rem;
        color: #64748b;
    }

    /* Modern content cards */
    .content-card {
        border: none;
        border-radius: var(--card-radius);
        box-shadow: var(--shadow-md);
        overflow: hidden;
    }

    .content-card .card-header {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: #fff;
        font-weight: 600;
        font-size: 1rem;
        padding: 1rem 1.25rem;
        border: none;
    }

    .content-card .card-body {
        background: #fff;
    }

    .running-balance-card .bg-warning {
        background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%) !important;
        border: 1px solid #ffcc80;
    }
</style>

<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-danger">
        <div class="container-fluid">

            <!-- LEFT MENU TOGGLER -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                    aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">

                <!-- LEFT NAV ITEMS -->
                <ul class="navbar-nav me-auto">

                    <!-- HOME -->
                    <li class="nav-item">
                        <a class="nav-link {% if request.endpoint == 'core.dashboard' %}active{% endif %}"
                        href="{{ url_for('core.dashboard') }}">
                            SMBC
                        </a>
                    </li>

                    <!-- SETTINGS -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle fw-bold"
                        href="#" role="button" data-bs-toggle="dropdown">
                            Settings
                        </a>
                        <ul class="dropdown-menu">
                            <li>
                                <a class="dropdown-item" href="{{ url_for('carenderia.manage_employee') }}">
                                    Manage Workers
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#manageDailyExpenseModal">
                                    Manage Daily Expense
                                </a>
                            </li>
                        </ul>
                    </li>

                    <!-- CORPORATE (visible only for Corporate users or Admin role) -->
                    {% if session.get('department') == 'Corporate' or session.get('role') == 'Admin' %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle fw-bold
                            {% if request.endpoint in ['carenderia.manage_department', 'carenderia.view_transactions', 'carenderia.monthly_trial_balance', 'carenderia.view_wages_report', 'carenderia.export_trial_balance'] %}active{% endif %}"
                        href="#" id="corporateDropdown" role="button"
                        data-bs-toggle="dropdown">
                            Corporate
                        </a>

                        <ul class="dropdown-menu" aria-labelledby="corporateDropdown">

                            <!-- Manage Department -->
                            <li>
                                <a class="dropdown-item"
                                href="{{ url_for('carenderia.manage_department') }}">
                                    Manage Department
                                </a>
                            </li>

                            <li><hr class="dropdown-divider"></li>

                            <!-- View Transactions Per Date -->
                            <li>
                                <a class="dropdown-item"
                                href="{{ url_for('carenderia.view_transactions') }}">
                                    View Transactions Per Date
                                </a>
                            </li>

                            <!-- Monthly Trial Balance Sheet -->
                            <li>
                                <a class="dropdown-item"
                                href="{{ url_for('carenderia.monthly_trial_balance') }}">
                                    Monthly Trial Balance Sheet
                                </a>
                            </li>

                            <!-- View Wages Report -->
                            <li>
                                <a class="dropdown-item"
                                href="{{ url_for('carenderia.view_wages_report') }}">
                                    View Wages Report
                                </a>
                            </li>

                            <li><hr class="dropdown-divider"></li>

                            <!-- Export Trial Balance -->
                            <li>
                                <a class="dropdown-item"
                                href="{{ url_for('carenderia.export_trial_balance') }}">
                                    Export Trial Balance
                                </a>
                            </li>

                        </ul>
                    </li>
                    {% endif %}

                </ul>

                <!-- RIGHT-SIDE: Carenderia + Logo dropdown (Logout submenu) -->
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle fw-bold text-white d-flex align-items-center py-0"
                           href="#" id="carenderiaNavDropdown" role="button"
                           data-bs-toggle="dropdown" aria-expanded="false">
                            <span>Carenderia</span>
                            <img src="{{ url_for('static', filename='images/wvc_logo.png') }}"
                                alt="WVC Logo"
                                class="ms-2" style="height: 28px; width: auto;">
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="carenderiaNavDropdown">
                            <li><a class="dropdown-item" href="{{ url_for('auth.logout') }}">Logout</a></li>
                        </ul>
                    </li>
                </ul>

            </div>
        </div>
    </nav>


    <!-- Main Content -->
    <div class="container container-mobile mt-4 pb-4">
        {% block content %}
        <!-- Dashboard header: Welcome (left) + Pastel quick-link cards (right) -->
        <div class="dashboard-header">
            <div class="dashboard-welcome">
                <h1>Welcome, {{ session.get('username', 'User') }}!</h1>
                <p class="text-muted mb-0">Carenderia Department Dashboard</p>
            </div>
            <div class="dashboard-cards">
                <a href="#entryFormCard" class="dash-card dash-card-main">
                    <div class="dash-card-title">New Entry</div>
                    <div class="dash-card-desc">Entry Form</div>
                </a>
                {% if session.get('department') == 'Corporate' or session.get('role') == 'Admin' %}
                <a href="{{ url_for('carenderia.view_transactions') }}" class="dash-card dash-card-transactions">
                    <div class="dash-card-title">Transactions</div>
                    <div class="dash-card-desc">View by date</div>
                </a>
                <a href="{{ url_for('carenderia.monthly_trial_balance') }}" class="dash-card dash-card-trial">
                    <div class="dash-card-title">Trial Balance</div>
                    <div class="dash-card-desc">Monthly</div>
                </a>
                <a href="{{ url_for('carenderia.view_wages_report') }}" class="dash-card dash-card-wages">
                    <div class="dash-card-title">Wages Report</div>
                    <div class="dash-card-desc">View report</div>
                </a>
                {% endif %}
            </div>
        </div>

        <!-- Entry Form Card -->
        <div id="entryFormCard" class="card content-card mt-4">
            <div class="card-header">
                <i class="bi bi-pencil-square me-2"></i>Entry Form
            </div>
            <div class="card-body">
                <form id="entryForm">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-3">
                            <label for="entryDate" class="form-label fw-bold">DATE</label>
                            <input type="date" class="form-control" id="entryDate" name="date" required>
                        </div>
                        <div class="col-md-4">
                            <label for="transactionType" class="form-label fw-bold">Type of Transaction</label>
                            <select class="form-select" id="transactionType" name="transaction_type" required>
                                <option value="">Select Type</option>
                                <option value="Daily Expense">Daily Expense</option>
                                <option value="Daily Sales">Daily Sales</option>
                                <option value="Purchases">Purchases</option>
                                <option value="Wages">Wages</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="amount" class="form-label fw-bold">Amount</label>
                            <input type="number" step="0.01" class="form-control" id="amount" name="amount" placeholder="0.00" required>
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-danger w-100">Save Entry</button>
                            <button type="reset" class="btn btn-secondary w-100 mt-2" id="clearFormBtn">Clear</button>
                        </div>
                    </div>
                    <!-- Hidden fields for Daily Expense transaction -->
                    <div class="row g-3 mt-2" id="dailyExpenseFields" style="display: none;">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-danger text-white">
                                    <h6 class="mb-0">Daily Expenses</h6>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive" style="max-height: 300px;">
                                        <table class="table table-sm table-bordered mb-0">
                                            <thead style="position: sticky; top: 0; background-color: #f8d7da; z-index: 10;">
                                                <tr>
                                                    <th style="background-color: #f8d7da;">Expense Type</th>
                                                    <th style="background-color: #f8d7da;" class="text-end">Amount (â‚±)</th>
                                                    <th style="background-color: #f8d7da;">Action</th>
                                                </tr>
                                            </thead>
                                            <tbody id="dailyExpenseEntriesTableBody">
                                                <tr>
                                                    <td colspan="3" class="text-center text-muted py-2" style="font-size: 0.85rem;">Loading...</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="card-footer bg-light">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <strong>Total Amount:</strong>
                                            <strong id="dailyExpenseGrandTotal">0.00</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Hidden fields for Purchases transaction -->
                    <div class="row g-3 mt-2" id="purchasesFields" style="display: none;">
                        <div class="col-md-8">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Reference #</label>
                                    <input type="text" class="form-control" id="purchasesReference" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Total Amount</label>
                                    <input type="text" class="form-control" id="purchasesTotalAmount" readonly>
                                </div>
                            </div>
                            <div class="row g-3 mt-2">
                                <div class="col-12">
                                    <div class="table-responsive" style="max-height: 400px;">
                                        <table class="table table-sm table-bordered">
                                            <thead class="table-danger" style="position: sticky; top: 0; z-index: 10;">
                                                <tr>
                                                    <th style="background-color: #f8d7da; width: 40%;">Description</th>
                                                    <th style="background-color: #f8d7da; width: 10%;">Qty</th>
                                                    <th style="background-color: #f8d7da; width: 15%;">Unit</th>
                                                    <th style="background-color: #f8d7da; width: 15%;" class="text-end">Unit Price</th>
                                                    <th style="background-color: #f8d7da; width: 15%;" class="text-end">Amount</th>
                                                    <th style="background-color: #f8d7da; width: 5%;">Action</th>
                                                </tr>
                                            </thead>
                                            <tbody id="purchasesItemsTableBody">
                                                <tr class="purchase-item-row">
                                                    <td><input type="text" class="form-control form-control-sm purchase-desc" placeholder="Description"></td>
                                                    <td><input type="number" step="0.01" class="form-control form-control-sm purchase-qty" placeholder="0" min="0"></td>
                                                    <td><input type="text" class="form-control form-control-sm purchase-unit" placeholder="Unit"></td>
                                                    <td><input type="number" step="0.01" class="form-control form-control-sm purchase-unit-price" placeholder="0.00" min="0"></td>
                                                    <td><input type="text" class="form-control form-control-sm purchase-amount" placeholder="0.00" readonly></td>
                                                    <td><button type="button" class="btn btn-sm btn-danger delete-purchase-item" style="display: none;">Delete</button></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header bg-danger text-white">
                                    <h6 class="mb-0">Purchase Items</h6>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive" style="max-height: 300px;">
                                        <table class="table table-sm table-bordered mb-0">
                                            <thead style="position: sticky; top: 0; background-color: #f8d7da; z-index: 10;">
                                                <tr>
                                                    <th style="background-color: #f8d7da;">Description</th>
                                                    <th style="background-color: #f8d7da;" class="text-end">Amount</th>
                                                </tr>
                                            </thead>
                                            <tbody id="purchasesEntriesTableBody">
                                                <tr>
                                                    <td colspan="2" class="text-center text-muted py-2" style="font-size: 0.85rem;">No items yet</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="card-footer bg-light">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <strong>Total:</strong>
                                            <strong id="purchasesGrandTotal">0.00</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Hidden fields for Wages transaction -->
                    <div class="row g-3 mt-2" id="wagesFields" style="display: none;">
                        <div class="col-md-8">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="wagesEmployee" class="form-label fw-bold">Employee</label>
                                    <select class="form-select" id="wagesEmployee" name="wages_employee">
                                        <option value="">Select Employee</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="wagesRatePerDay" class="form-label fw-bold">Rate per Day</label>
                                    <input type="number" step="0.01" class="form-control" id="wagesRatePerDay" name="wages_rate_per_day" placeholder="0.00" readonly>
                                </div>
                                <div class="col-md-3">
                                    <label for="wagesDays" class="form-label fw-bold">Number of Days</label>
                                    <input type="number" step="0.01" class="form-control" id="wagesDays" name="wages_days" placeholder="0" min="0">
                                </div>
                            </div>
                            <div class="row g-3 mt-2">
                                <div class="col-md-3">
                                    <label for="wagesOvertimeHours" class="form-label fw-bold">Overtime Hours</label>
                                    <input type="number" step="0.01" class="form-control" id="wagesOvertimeHours" name="wages_overtime_hours" placeholder="0" min="0">
                                </div>
                                <div class="col-md-3">
                                    <label for="wagesOvertimeAmount" class="form-label fw-bold">Overtime Amount</label>
                                    <input type="text" class="form-control" id="wagesOvertimeAmount" name="wages_overtime_amount" placeholder="0.00" readonly>
                                </div>
                                <div class="col-md-3">
                                    <label for="wagesTotalAmount" class="form-label fw-bold">Total Amount</label>
                                    <input type="text" class="form-control" id="wagesTotalAmount" name="wages_total_amount" placeholder="0.00" readonly>
                                </div>
                                <div class="col-md-3 d-flex align-items-end">
                                    <button type="button" class="btn btn-danger w-100" id="addWagesEmployeeBtn">Add Employee</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header bg-danger text-white">
                                    <h6 class="mb-0">Wages Entries</h6>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive" style="max-height: 300px;">
                                        <table class="table table-sm table-bordered mb-0">
                                            <thead style="position: sticky; top: 0; background-color: #f8d7da; z-index: 10;">
                                                <tr>
                                                    <th style="background-color: #f8d7da;">Date</th>
                                                    <th style="background-color: #f8d7da;">Employee</th>
                                                    <th style="background-color: #f8d7da;">Total Amount</th>
                                                    <th style="background-color: #f8d7da;">Action</th>
                                                </tr>
                                            </thead>
                                            <tbody id="wagesEntriesTableBody">
                                                <tr>
                                                    <td colspan="4" class="text-center text-muted py-2" style="font-size: 0.85rem;">No entries yet</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="card-footer bg-light">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <strong>Grand Total:</strong>
                                            <strong id="wagesGrandTotal">0.00</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Transactions Table -->
        <div class="card content-card mt-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-list-ul me-2"></i>Transaction Records</span>
                <button type="button" class="btn btn-light btn-sm" id="submitTransactionsBtn">
                    Submit Transaction
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-bordered table-sm align-middle mb-0" style="font-size: 0.85rem;">
                        <thead style="position: sticky; top: 0; z-index: 100; background-color: #f8d7da;">
                            <tr>
                                <th style="background-color: #f8d7da;">DATE</th>
                                <th style="background-color: #f8d7da;">Type</th>
                                <th style="background-color: #f8d7da;">Amount</th>
                                <th style="background-color: #f8d7da;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsTableBody">
                            <!-- Table rows will be populated here -->
                            <tr>
                                <td colspan="4" class="text-center text-muted py-4">No transactions yet. Add an entry above.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Running Balance Card -->
        <div class="card content-card running-balance-card mt-4">
            <div class="card-header">
                <i class="bi bi-calculator me-2"></i>Running Balance
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center p-2 bg-light rounded" style="border-radius: 8px;">
                                <span class="fw-bold">Daily Collection</span>
                                <span class="fw-bold" id="runningDailyCollection">0.00</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="fw-bold mb-3">Deductions:</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered mb-0">
                                <tbody>
                                    <tr id="rowDeductionDailyExpense">
                                        <td class="fw-bold">Daily Expense</td>
                                        <td class="text-end" id="deductionDailyExpense">0.00</td>
                                    </tr>
                                    <tr id="rowDeductionPurchases">
                                        <td class="fw-bold">Purchases</td>
                                        <td class="text-end" id="deductionPurchases">0.00</td>
                                    </tr>
                                    <tr id="rowDeductionWages">
                                        <td class="fw-bold">Wages</td>
                                        <td class="text-end" id="deductionWages">0.00</td>
                                    </tr>
                                    <tr class="table-secondary">
                                        <td class="fw-bold">Total Deductions</td>
                                        <td class="text-end fw-bold" id="runningTotalDeductions">0.00</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center p-3 bg-warning text-dark rounded running-balance-card">
                            <span class="fw-bold fs-5">Total Amount (Daily Collection - Deductions)</span>
                            <span class="fw-bold fs-5" id="runningNetAmount">0.00</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Transaction Modal -->
        <div class="modal fade" id="editTransactionModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form id="editTransactionForm">
                        <div class="modal-header">
                            <h5 class="modal-title">Edit Transaction</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="editDate" class="form-label fw-bold">DATE</label>
                                <input type="date" class="form-control" id="editDate" name="date" required>
                            </div>
                            <div class="mb-3">
                                <label for="editTransactionType" class="form-label fw-bold">Type of Transaction</label>
                                <select class="form-select" id="editTransactionType" name="transaction_type" required>
                                    <option value="">Select Type</option>
                                    <option value="Daily Expense">Daily Expense</option>
                                    <option value="Daily Sales">Daily Sales</option>
                                    <option value="Purchases">Purchases</option>
                                    <option value="Wages">Wages</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="editAmount" class="form-label fw-bold">Amount</label>
                                <input type="number" step="0.01" class="form-control" id="editAmount" name="amount" placeholder="0.00" required>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-danger">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        {% endblock %}
    </div>


    {% block scripts %}
    <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
    <script>
        // Store transactions in memory (will be replaced with backend later)
        let transactions = [];
        let carenderiaEmployees = [];
        let wagesEntries = []; // Store individual employee wage entries

        // Helper function to format numbers with commas
        function formatAmount(num) {
            return parseFloat(num || 0).toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        // Load Carenderia employees
        async function loadCarenderiaEmployees() {
            try {
                const response = await fetch('{{ url_for("carenderia.get_carenderia_employees") }}');
                const data = await response.json();
                carenderiaEmployees = data.employees || [];
                
                // Populate employee dropdown
                const employeeSelect = document.getElementById('wagesEmployee');
                employeeSelect.innerHTML = '<option value="">Select Employee</option>';
                carenderiaEmployees.forEach(emp => {
                    const option = document.createElement('option');
                    option.value = emp.id;
                    option.textContent = emp.name;
                    option.setAttribute('data-rate', emp.rate_per_day || 0);
                    option.setAttribute('data-dept-id', emp.department_id || '');
                    option.setAttribute('data-role', emp.role || '');
                    employeeSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading employees:', error);
            }
        }

        // Store selected daily expenses (will be added as transactions on Save Entry)
        let selectedDailyExpenses = [];
        
        // Store purchase items
        let purchaseItems = [];
        let purchaseReferenceCounter = 1;

        // Generate purchase reference number
        function generatePurchaseReference() {
            const date = new Date();
            const dateStr = date.toISOString().slice(0, 10).replace(/-/g, '');
            return `PUR-${dateStr}-${String(purchaseReferenceCounter).padStart(4, '0')}`;
        }

        // Show/hide fields based on transaction type
        document.getElementById('transactionType').addEventListener('change', function() {
            const wagesFields = document.getElementById('wagesFields');
            const dailyExpenseFields = document.getElementById('dailyExpenseFields');
            const purchasesFields = document.getElementById('purchasesFields');
            const amountField = document.getElementById('amount');
            
            if (this.value === 'Wages') {
                wagesFields.style.display = 'block';
                dailyExpenseFields.style.display = 'none';
                purchasesFields.style.display = 'none';
                amountField.readOnly = true;
                amountField.value = '';
                loadCarenderiaEmployees();
            } else if (this.value === 'Daily Expense') {
                wagesFields.style.display = 'none';
                dailyExpenseFields.style.display = 'block';
                purchasesFields.style.display = 'none';
                amountField.readOnly = true;
                amountField.value = '';
                loadDailyExpensesForEntry();
            } else if (this.value === 'Purchases') {
                wagesFields.style.display = 'none';
                dailyExpenseFields.style.display = 'none';
                purchasesFields.style.display = 'block';
                amountField.readOnly = true;
                amountField.value = '';
                initializePurchasesForm();
            } else {
                wagesFields.style.display = 'none';
                dailyExpenseFields.style.display = 'none';
                purchasesFields.style.display = 'none';
                amountField.readOnly = false;
                // Clear wages input fields but keep entries in memory
                document.getElementById('wagesEmployee').value = '';
                document.getElementById('wagesRatePerDay').value = '';
                document.getElementById('wagesDays').value = '';
                document.getElementById('wagesOvertimeHours').value = '';
                document.getElementById('wagesOvertimeAmount').value = '';
                document.getElementById('wagesTotalAmount').value = '';
                amountField.value = '';
                // Note: wagesEntries, selectedDailyExpenses, and purchaseItems are NOT cleared here - they persist until Submit Transaction
            }
        });

        // Initialize purchases form
        function initializePurchasesForm() {
            // Generate reference number
            document.getElementById('purchasesReference').value = generatePurchaseReference();
            // Reset purchase items table to have one empty row
            const tbody = document.getElementById('purchasesItemsTableBody');
            tbody.innerHTML = `
                <tr class="purchase-item-row">
                    <td><input type="text" class="form-control form-control-sm purchase-desc" placeholder="Description"></td>
                    <td><input type="number" step="0.01" class="form-control form-control-sm purchase-qty" placeholder="0" min="0"></td>
                    <td><input type="text" class="form-control form-control-sm purchase-unit" placeholder="Unit"></td>
                    <td><input type="number" step="0.01" class="form-control form-control-sm purchase-unit-price" placeholder="0.00" min="0"></td>
                    <td><input type="text" class="form-control form-control-sm purchase-amount" placeholder="0.00" readonly></td>
                    <td><button type="button" class="btn btn-sm btn-danger delete-purchase-item" style="display: none;">Delete</button></td>
                </tr>
            `;
            // Attach event listeners to the new row
            attachPurchaseRowListeners(tbody.querySelector('.purchase-item-row'));
            purchaseItems = [];
            updatePurchasesEntriesTable();
            updatePurchasesTotal();
        }

        // Attach event listeners to a purchase row
        function attachPurchaseRowListeners(row) {
            const qtyInput = row.querySelector('.purchase-qty');
            const unitPriceInput = row.querySelector('.purchase-unit-price');
            const descInput = row.querySelector('.purchase-desc');
            const unitInput = row.querySelector('.purchase-unit');
            const amountInput = row.querySelector('.purchase-amount');
            const deleteBtn = row.querySelector('.delete-purchase-item');

            // Calculate amount when qty or unit price changes
            function calculateRowAmount() {
                const qty = parseFloat(qtyInput.value) || 0;
                const unitPrice = parseFloat(unitPriceInput.value) || 0;
                const amount = qty * unitPrice;
                amountInput.value = formatAmount(amount);
                updatePurchasesTotal();
            }

            qtyInput.addEventListener('input', calculateRowAmount);
            unitPriceInput.addEventListener('input', calculateRowAmount);

            // When Enter is pressed on description, move focus to qty
            descInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    qtyInput.focus();
                    qtyInput.select(); // Select the value for easy editing
                }
            });

            // When Enter is pressed on qty, move focus to unit
            qtyInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    unitInput.focus();
                    unitInput.select();
                }
            });

            // When Enter is pressed on unit, move focus to unit_price
            unitInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    unitPriceInput.focus();
                    unitPriceInput.select();
                }
            });

            // When Enter is pressed on unit_price, add new row
            unitPriceInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    // Only add new row if current row has valid data
                    const desc = descInput.value.trim();
                    const qty = parseFloat(qtyInput.value) || 0;
                    const unit = unitInput.value.trim();
                    const unitPrice = parseFloat(unitPriceInput.value) || 0;
                    
                    if (desc && qty > 0 && unitPrice > 0) {
                        // Check if this row is already saved (has data-index)
                        const rowIndex = row.getAttribute('data-index');
                        if (rowIndex === null || rowIndex === '') {
                            // Save current row to purchaseItems (but keep the row visible with its data)
                            addPurchaseItemToArray(desc, qty, unit, unitPrice);
                            row.setAttribute('data-index', purchaseItems.length - 1);
                            // Make inputs readonly or disabled to show they're saved (optional - or keep editable)
                            // For now, keep them editable but mark as saved
                            updatePurchasesEntriesTable();
                            updatePurchasesTotal();
                            updatePurchaseDeleteButtons();
                        }
                        // DON'T clear current row - keep its entries visible
                        // Add new blank row below
                        addNewPurchaseRow();
                        // Focus on description of new row
                        setTimeout(() => {
                            const newRow = document.querySelector('.purchase-item-row:last-child');
                            if (newRow) {
                                newRow.querySelector('.purchase-desc').focus();
                            }
                        }, 10);
                    }
                }
            });

            // Delete button
            deleteBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                const index = parseInt(row.getAttribute('data-index'));
                if (index >= 0 && index < purchaseItems.length) {
                    purchaseItems.splice(index, 1);
                    row.remove();
                    reindexPurchaseRows();
                    updatePurchaseDeleteButtons();
                    updatePurchasesEntriesTable();
                    updatePurchasesTotal();
                } else {
                    // If not in array, just remove the row
                    row.remove();
                    updatePurchaseDeleteButtons();
                    updatePurchasesTotal();
                }
            });
        }

        // Add purchase item to array
        function addPurchaseItemToArray(desc, qty, unit, unitPrice) {
            purchaseItems.push({
                description: desc,
                qty: qty,
                unit: unit,
                unit_price: unitPrice,
                amount: qty * unitPrice
            });
        }

        // Add new purchase row
        function addNewPurchaseRow() {
            const tbody = document.getElementById('purchasesItemsTableBody');
            const newRow = document.createElement('tr');
            newRow.className = 'purchase-item-row';
            newRow.innerHTML = `
                <td><input type="text" class="form-control form-control-sm purchase-desc" placeholder="Description"></td>
                <td><input type="number" step="0.01" class="form-control form-control-sm purchase-qty" placeholder="0" min="0"></td>
                <td><input type="text" class="form-control form-control-sm purchase-unit" placeholder="Unit"></td>
                <td><input type="number" step="0.01" class="form-control form-control-sm purchase-unit-price" placeholder="0.00" min="0"></td>
                <td><input type="text" class="form-control form-control-sm purchase-amount" placeholder="0.00" readonly></td>
                <td><button type="button" class="btn btn-sm btn-danger delete-purchase-item">Delete</button></td>
            `;
            tbody.appendChild(newRow);
            attachPurchaseRowListeners(newRow);
            // Show delete buttons on all rows except the last one
            updatePurchaseDeleteButtons();
        }

        // Reindex purchase rows
        function reindexPurchaseRows() {
            const rows = document.querySelectorAll('.purchase-item-row');
            rows.forEach((row, index) => {
                row.setAttribute('data-index', index);
            });
        }

        // Update delete buttons visibility
        function updatePurchaseDeleteButtons() {
            const rows = document.querySelectorAll('.purchase-item-row');
            rows.forEach((row, index) => {
                const deleteBtn = row.querySelector('.delete-purchase-item');
                if (rows.length > 1) {
                    deleteBtn.style.display = '';
                } else {
                    deleteBtn.style.display = 'none';
                }
            });
        }

        // Update purchases entries table (right side card)
        function updatePurchasesEntriesTable() {
            const tbody = document.getElementById('purchasesEntriesTableBody');
            tbody.innerHTML = '';
            
            if (purchaseItems.length === 0) {
                tbody.innerHTML = '<tr><td colspan="2" class="text-center text-muted py-2" style="font-size: 0.85rem;">No items yet</td></tr>';
                return;
            }
            
            purchaseItems.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.description}</td>
                    <td class="text-end">${formatAmount(item.amount)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Update purchases total
        function updatePurchasesTotal() {
            // Calculate total from purchaseItems array
            const total = purchaseItems.reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);
            document.getElementById('purchasesTotalAmount').value = formatAmount(total);
            document.getElementById('purchasesGrandTotal').textContent = formatAmount(total);
        }

        // Load daily expenses for entry form
        async function loadDailyExpensesForEntry() {
            try {
                const response = await fetch('{{ url_for("carenderia.get_daily_expenses") }}');
                const data = await response.json();
                if (data.success && data.expenses) {
                    // Initialize selectedDailyExpenses with all expenses that have amount > 0
                    selectedDailyExpenses = data.expenses
                        .filter(exp => parseFloat(exp.amount || 0) > 0)
                        .map(exp => ({
                            expense_type: exp.expense_type,
                            amount: parseFloat(exp.amount || 0)
                        }));
                    renderDailyExpenseEntriesTable();
                    updateDailyExpenseGrandTotal();
                } else {
                    selectedDailyExpenses = [];
                    renderDailyExpenseEntriesTable();
                }
            } catch (error) {
                console.error('Error loading daily expenses:', error);
                selectedDailyExpenses = [];
                renderDailyExpenseEntriesTable();
            }
        }

        function renderDailyExpenseEntriesTable() {
            const tbody = document.getElementById('dailyExpenseEntriesTableBody');
            tbody.innerHTML = '';
            
            if (selectedDailyExpenses.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted py-2" style="font-size: 0.85rem;">No daily expenses with amount > 0</td></tr>';
                return;
            }
            
            selectedDailyExpenses.forEach((expense, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${expense.expense_type}</td>
                    <td class="text-end">${parseFloat(expense.amount || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td>
                        <button type="button" class="btn btn-sm btn-danger delete-daily-expense-btn" data-index="${index}">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateDailyExpenseGrandTotal() {
            const total = selectedDailyExpenses.reduce((sum, exp) => sum + parseFloat(exp.amount || 0), 0);
            document.getElementById('dailyExpenseGrandTotal').textContent = formatAmount(total);
        }

        // Delete daily expense from selected list
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('delete-daily-expense-btn')) {
                const index = parseInt(e.target.getAttribute('data-index'));
                selectedDailyExpenses.splice(index, 1);
                renderDailyExpenseEntriesTable();
                updateDailyExpenseGrandTotal();
            }
        });

        // Auto-fill rate per day when employee is selected
        document.getElementById('wagesEmployee').addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const ratePerDay = selectedOption.getAttribute('data-rate') || 0;
            document.getElementById('wagesRatePerDay').value = formatAmount(ratePerDay);
            calculateWagesTotal();
        });

        // Auto-calculate total amount when days, rate, or overtime hours changes
        document.getElementById('wagesDays').addEventListener('input', calculateWagesTotal);
        document.getElementById('wagesRatePerDay').addEventListener('input', calculateWagesTotal);
        document.getElementById('wagesOvertimeHours').addEventListener('input', calculateWagesTotal);

        function calculateWagesTotal() {
            // Parse ratePerDay, removing commas from formatted string
            const ratePerDayStr = document.getElementById('wagesRatePerDay').value.replace(/,/g, '');
            const ratePerDay = parseFloat(ratePerDayStr) || 0;
            const days = parseFloat(document.getElementById('wagesDays').value) || 0;
            const overtimeHours = parseFloat(document.getElementById('wagesOvertimeHours').value) || 0;
            
            // Calculate overtime amount: (rate_per_day / 8 hours) * overtime_hours
            const ratePerHour = ratePerDay / 8;
            const overtimeAmount = ratePerHour * overtimeHours;
            
            // Calculate total amount: (rate_per_day * days) + overtime_amount
            const regularAmount = ratePerDay * days;
            const totalAmount = regularAmount + overtimeAmount;
            
            // Update overtime amount field (use text input, so formatAmount with commas works)
            document.getElementById('wagesOvertimeAmount').value = formatAmount(overtimeAmount);
            
            // Update total amount field (use text input, so formatAmount with commas works)
            document.getElementById('wagesTotalAmount').value = formatAmount(totalAmount);
            updateWagesGrandTotal();
        }

        // Add employee to wages entries
        document.getElementById('addWagesEmployeeBtn').addEventListener('click', function() {
            const entryDate = document.getElementById('entryDate').value;
            const employeeSelect = document.getElementById('wagesEmployee');
            const employeeId = employeeSelect.value;
            const employeeName = employeeSelect.options[employeeSelect.selectedIndex].text;
            const employeeDeptId = employeeSelect.options[employeeSelect.selectedIndex].getAttribute('data-dept-id') || null;
            const employeeRole = employeeSelect.options[employeeSelect.selectedIndex].getAttribute('data-role') || null;
            const ratePerDay = parseFloat(document.getElementById('wagesRatePerDay').value.replace(/,/g, '')) || 0;
            const days = parseFloat(document.getElementById('wagesDays').value) || 0;
            const overtimeHours = parseFloat(document.getElementById('wagesOvertimeHours').value) || 0;
            // Parse overtime amount, removing commas from formatted string
            const overtimeAmountStr = document.getElementById('wagesOvertimeAmount').value.replace(/,/g, '');
            const overtimeAmount = parseFloat(overtimeAmountStr) || 0;
            
            if (!entryDate) {
                alert('Please select a date first.');
                return;
            }
            
            if (!employeeId) {
                alert('Please select an employee.');
                return;
            }
            
            if (days <= 0 && overtimeHours <= 0) {
                alert('Please enter a valid number of days or overtime hours.');
                return;
            }
            
            // Check if employee already exists
            const existingIndex = wagesEntries.findIndex(e => e.employeeId === parseInt(employeeId));
            // Total amount includes overtime: (rate_per_day * days) + overtime_amount
            const regularAmount = ratePerDay * days;
            const totalAmount = regularAmount + overtimeAmount;
            
            if (existingIndex >= 0) {
                // Update existing entry
                wagesEntries[existingIndex].ratePerDay = ratePerDay;
                wagesEntries[existingIndex].days = days;
                wagesEntries[existingIndex].overtimeHours = overtimeHours;
                wagesEntries[existingIndex].overtimeAmount = overtimeAmount;
                wagesEntries[existingIndex].totalAmount = totalAmount;
                wagesEntries[existingIndex].departmentId = employeeDeptId ? parseInt(employeeDeptId) : null;
                wagesEntries[existingIndex].employeeRole = employeeRole;
                wagesEntries[existingIndex].date = entryDate;
            } else {
                // Add new entry
                wagesEntries.push({
                    id: wagesEntries.length > 0 ? Math.max(...wagesEntries.map(e => e.id)) + 1 : 1,
                    employeeId: parseInt(employeeId),
                    employeeName: employeeName,
                    departmentId: employeeDeptId ? parseInt(employeeDeptId) : null,
                    employeeRole: employeeRole,
                    ratePerDay: ratePerDay,
                    days: days,
                    overtimeHours: overtimeHours,
                    overtimeAmount: overtimeAmount,
                    totalAmount: totalAmount,
                    date: entryDate
                });
            }
            
            updateWagesEntriesTable();
            
            // Clear form fields
            employeeSelect.value = '';
            document.getElementById('wagesRatePerDay').value = '';
            document.getElementById('wagesDays').value = '';
            document.getElementById('wagesOvertimeHours').value = '';
            document.getElementById('wagesOvertimeAmount').value = '';
            document.getElementById('wagesTotalAmount').value = '';
        });

        // Update wages entries table
        function updateWagesEntriesTable() {
            const tbody = document.getElementById('wagesEntriesTableBody');
            tbody.innerHTML = '';
            
            if (wagesEntries.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-2" style="font-size: 0.85rem;">No entries yet</td></tr>';
                updateWagesGrandTotal();
                return;
            }
            
            wagesEntries.forEach(entry => {
                const row = document.createElement('tr');
                const dateDisplay = entry.date ? new Date(entry.date).toLocaleDateString() : 'N/A';
                row.innerHTML = `
                    <td>${dateDisplay}</td>
                    <td>${entry.employeeName}</td>
                    <td class="text-end">${formatAmount(entry.totalAmount)}</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-danger delete-wages-entry" data-id="${entry.id}">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Add delete event listeners
            document.querySelectorAll('.delete-wages-entry').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    wagesEntries = wagesEntries.filter(e => e.id !== id);
                    updateWagesEntriesTable();
                });
            });
            
            updateWagesGrandTotal();
        }

        // Update grand total for wages
        function updateWagesGrandTotal() {
            const grandTotal = wagesEntries.reduce((sum, entry) => sum + entry.totalAmount, 0);
            document.getElementById('wagesGrandTotal').textContent = formatAmount(grandTotal);
            document.getElementById('amount').value = formatAmount(grandTotal);
        }

        // Define expense types (for calculating cash out)
        const expenseTypes = ['Daily Expense', 'Purchases', 'Wages'];
        const incomeTypes = ['Daily Sales'];

        // Check if transaction type is an expense
        function isExpense(type) {
            return expenseTypes.includes(type);
        }

        // Check if transaction type is income
        function isIncome(type) {
            return incomeTypes.includes(type);
        }

        // Calculate totals from transactions
        function calculateTotals() {
            let totalExpenses = 0;
            let totalIncome = 0;
            let cashOnHand = 0;

            // Sort transactions by date and id to calculate in order
            const sortedTransactions = [...transactions].sort((a, b) => {
                if (a.date !== b.date) {
                    return new Date(a.date) - new Date(b.date);
                }
                return a.id - b.id;
            });

            sortedTransactions.forEach(trans => {
                const amount = parseFloat(trans.amount) || 0;
                if (isExpense(trans.transactionType)) {
                    totalExpenses += amount;
                    cashOnHand -= amount;
                } else if (isIncome(trans.transactionType)) {
                    totalIncome += amount;
                    cashOnHand += amount;
                }
            });

            return { totalExpenses, totalIncome, cashOnHand };
        }

        // Update running balance
        function updateRunningBalance() {
            // Calculate totals by transaction type
            let dailyCollection = 0;
            let dailyExpense = 0;
            let purchases = 0;
            let wages = 0;

            transactions.forEach(trans => {
                const amount = parseFloat(trans.amount) || 0;
                const type = trans.transactionType;

                if (type === 'Daily Sales') {
                    dailyCollection += amount;
                } else if (type === 'Daily Expense') {
                    dailyExpense += amount;
                } else if (type === 'Purchases') {
                    purchases += amount;
                } else if (type === 'Wages') {
                    wages += amount;
                }
            });

            const totalDeductions = dailyExpense + purchases + wages;
            const netAmount = dailyCollection - totalDeductions;

            // Update running balance display
            document.getElementById('runningDailyCollection').textContent = formatAmount(dailyCollection);
            
            // Update deduction amounts and show/hide rows based on amount
            updateDeductionRow('rowDeductionDailyExpense', 'deductionDailyExpense', dailyExpense);
            updateDeductionRow('rowDeductionPurchases', 'deductionPurchases', purchases);
            updateDeductionRow('rowDeductionWages', 'deductionWages', wages);
            
            document.getElementById('runningTotalDeductions').textContent = formatAmount(totalDeductions);
            document.getElementById('runningNetAmount').textContent = formatAmount(netAmount);
        }

        // Helper function to update deduction row and show/hide based on amount
        function updateDeductionRow(rowId, amountId, amount) {
            const row = document.getElementById(rowId);
            const amountElement = document.getElementById(amountId);
            
            if (amount > 0) {
                row.style.display = '';
                amountElement.textContent = formatAmount(amount);
            } else {
                row.style.display = 'none';
                amountElement.textContent = formatAmount(0);
            }
        }

        // Update summary panels (now only updates running balance)
        function updateSummaryPanels() {
            // Update running balance
            updateRunningBalance();
        }

        // Recalculate cash on hand for all transactions
        function recalculateCashOnHand() {
            let runningCash = 0;
            transactions.forEach(trans => {
                const amount = parseFloat(trans.amount) || 0;
                if (isExpense(trans.transactionType)) {
                    runningCash -= amount;
                } else if (isIncome(trans.transactionType)) {
                    runningCash += amount;
                }
                trans.cashOnHand = runningCash;
            });
        }

        // Handle form submission
        document.getElementById('entryForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const entryDate = document.getElementById('entryDate').value;
            const transactionType = document.getElementById('transactionType').value;
            let amount = parseFloat(document.getElementById('amount').value) || 0;
            
            if (!entryDate) {
                alert('Please select a date.');
                return;
            }

            if (!transactionType) {
                alert('Please select a transaction type.');
                return;
            }

            // Handle Daily Expense: add each selected expense as a transaction
            if (transactionType === 'Daily Expense') {
                if (selectedDailyExpenses.length === 0) {
                    alert('No daily expenses selected. Please ensure there are expenses with amount > 0.');
                    return;
                }
                
                // Add each daily expense as a separate transaction
                let nextId = transactions.length > 0 ? Math.max(...transactions.map(t => t.id)) + 1 : 1;
                selectedDailyExpenses.forEach(expense => {
                    const transaction = {
                        id: nextId++,
                        date: entryDate,
                        transactionType: 'Daily Expense',
                        amount: expense.amount,
                        expenseType: expense.expense_type // Store for display
                    };
                    transactions.push(transaction);
                });
                
                recalculateCashOnHand();
                updateTransactionsTable();
                updateSummaryPanels();
                this.reset();
                
                // Reset daily expense fields
                document.getElementById('dailyExpenseFields').style.display = 'none';
                document.getElementById('amount').readOnly = false;
                document.getElementById('transactionType').value = '';
                // Clear selected expenses after adding to transactions
                selectedDailyExpenses = [];
                renderDailyExpenseEntriesTable();
                updateDailyExpenseGrandTotal();
                return;
            }

            // Handle Purchases: add as one transaction with items
            if (transactionType === 'Purchases') {
                // Collect items from current form rows (including the one being edited)
                const rows = document.querySelectorAll('.purchase-item-row');
                const currentItems = [];
                rows.forEach(row => {
                    const desc = row.querySelector('.purchase-desc').value.trim();
                    const qty = parseFloat(row.querySelector('.purchase-qty').value) || 0;
                    const unit = row.querySelector('.purchase-unit').value.trim();
                    const unitPrice = parseFloat(row.querySelector('.purchase-unit-price').value) || 0;
                    
                    // Only add if row has valid data
                    if (desc && qty > 0 && unitPrice > 0) {
                        // Check if this row is already in purchaseItems (has data-index)
                        const rowIndex = row.getAttribute('data-index');
                        if (rowIndex === null || rowIndex === '') {
                            // New item, add to currentItems
                            currentItems.push({
                                description: desc,
                                qty: qty,
                                unit: unit,
                                unit_price: unitPrice,
                                amount: qty * unitPrice
                            });
                        }
                        // If rowIndex exists, it's already in purchaseItems, skip
                    }
                });
                
                // Merge with existing purchaseItems
                const allItems = [...purchaseItems, ...currentItems];
                
                if (allItems.length === 0) {
                    alert('Please add at least one purchase item.');
                    return;
                }
                
                const referenceNumber = document.getElementById('purchasesReference').value;
                const totalAmount = allItems.reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);
                
                // Add as ONE transaction with items stored
                const transaction = {
                    id: transactions.length > 0 ? Math.max(...transactions.map(t => t.id)) + 1 : 1,
                    date: entryDate,
                    transactionType: 'Purchases',
                    amount: totalAmount,
                    referenceNumber: referenceNumber,
                    items: allItems // Store items for expansion
                };
                
                transactions.push(transaction);
                recalculateCashOnHand();
                updateTransactionsTable();
                updateSummaryPanels();
                this.reset();
                
                // Reset purchases fields
                document.getElementById('purchasesFields').style.display = 'none';
                document.getElementById('amount').readOnly = false;
                document.getElementById('transactionType').value = '';
                purchaseItems = [];
                purchaseReferenceCounter++;
                initializePurchasesForm();
                return;
            }

            // Validate wages fields if transaction type is Wages
            if (transactionType === 'Wages') {
                if (wagesEntries.length === 0) {
                    alert('Please add at least one employee wage entry.');
                    return;
                }
                
                // Use grand total from all wages entries
                amount = wagesEntries.reduce((sum, entry) => sum + entry.totalAmount, 0);
            }

            if (amount <= 0) {
                alert('Please enter a valid amount.');
                return;
            }

            // Create transaction object
            const transaction = {
                id: transactions.length > 0 ? Math.max(...transactions.map(t => t.id)) + 1 : 1,
                date: entryDate,
                transactionType: transactionType,
                amount: amount
            };

            // For Wages, store the wage entries with the transaction
            if (transactionType === 'Wages') {
                // Create a copy of wagesEntries to store with this transaction
                transaction.wageEntries = JSON.parse(JSON.stringify(wagesEntries));
            }

            transactions.push(transaction);
            recalculateCashOnHand();
            updateTransactionsTable();
            updateSummaryPanels();
            this.reset();
            
            // Reset wages fields visibility
            if (transactionType === 'Wages') {
                // For Wages, hide the fields but keep entries in memory for next transaction
                document.getElementById('wagesFields').style.display = 'none';
                document.getElementById('amount').readOnly = false;
                // Clear the input fields but keep wagesEntries for potential next transaction
                document.getElementById('wagesEmployee').value = '';
                document.getElementById('wagesRatePerDay').value = '';
                document.getElementById('wagesDays').value = '';
                document.getElementById('wagesOvertimeHours').value = '';
                document.getElementById('wagesOvertimeAmount').value = '';
                document.getElementById('wagesTotalAmount').value = '';
                // Reset transaction type dropdown
                document.getElementById('transactionType').value = '';
                // Note: wagesEntries are kept in memory for potential next Wages transaction
            } else {
                document.getElementById('wagesFields').style.display = 'none';
                document.getElementById('amount').readOnly = false;
            }
        });

        // Handle edit form submission
        let editingTransactionId = null;
        document.getElementById('editTransactionForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!editingTransactionId) return;

            const entryDate = document.getElementById('editDate').value;
            const transactionType = document.getElementById('editTransactionType').value;
            const amount = parseFloat(document.getElementById('editAmount').value) || 0;
            
            if (!entryDate || !transactionType || amount <= 0) {
                alert('Please fill in all fields correctly.');
                return;
            }

            // Find and update transaction
            const transaction = transactions.find(t => t.id === editingTransactionId);
            if (transaction) {
                transaction.date = entryDate;
                transaction.transactionType = transactionType;
                transaction.amount = amount;
                
                recalculateCashOnHand();
                updateTransactionsTable();
                updateSummaryPanels();
                
                bootstrap.Modal.getInstance(document.getElementById('editTransactionModal')).hide();
                editingTransactionId = null;
            }
        });

        // Update transactions table - show each transaction individually
        function updateTransactionsTable() {
            const tbody = document.getElementById('transactionsTableBody');
            tbody.innerHTML = '';

            if (transactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-4">No transactions yet. Add an entry above.</td></tr>';
                return;
            }

            // Sort transactions by date and id
            const sortedTransactions = [...transactions].sort((a, b) => {
                if (a.date !== b.date) {
                    return new Date(a.date) - new Date(b.date);
                }
                return a.id - b.id;
            });

            sortedTransactions.forEach(trans => {
                const amount = parseFloat(trans.amount) || 0;
                const type = trans.transactionType;
                // For Daily Expense, show the expense type name
                const displayType = (type === 'Daily Expense' && trans.expenseType) 
                    ? `${type} (${trans.expenseType})` 
                    : type;
                
                // For Purchases, show reference number
                const displayTypeWithRef = (type === 'Purchases' && trans.referenceNumber)
                    ? `${type} (${trans.referenceNumber})`
                    : displayType;

                const row = document.createElement('tr');
                row.className = 'transaction-row';
                row.setAttribute('data-transaction-id', trans.id);
                
                // Make Purchases and Wages rows clickable
                if ((type === 'Purchases' && trans.items && trans.items.length > 0) ||
                    (type === 'Wages' && trans.wageEntries && trans.wageEntries.length > 0)) {
                    row.style.cursor = 'pointer';
                    if (type === 'Purchases') {
                        row.classList.add('purchases-expandable');
                    } else if (type === 'Wages') {
                        row.classList.add('wages-expandable');
                    }
                }
                
                // Add chevron icon for expandable rows
                let chevronIcon = '';
                if (type === 'Purchases' && trans.items && trans.items.length > 0) {
                    chevronIcon = '<i class="bi bi-chevron-down ms-1"></i>';
                } else if (type === 'Wages' && trans.wageEntries && trans.wageEntries.length > 0) {
                    chevronIcon = '<i class="bi bi-chevron-down ms-1"></i>';
                }
                
                row.innerHTML = `
                    <td>${new Date(trans.date).toLocaleDateString()}</td>
                    <td>${displayTypeWithRef}${chevronIcon}</td>
                    <td class="fw-bold">${formatAmount(amount)}</td>
                    <td>
                        <button class="btn btn-sm btn-warning edit-transaction me-1" data-id="${trans.id}">Edit</button>
                        <button class="btn btn-sm btn-danger delete-transaction" data-id="${trans.id}">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
                
                // Add expandable items row for Purchases
                if (type === 'Purchases' && trans.items && trans.items.length > 0) {
                    const itemsRow = document.createElement('tr');
                    itemsRow.className = 'purchases-items-row';
                    itemsRow.style.display = 'none';
                    itemsRow.setAttribute('data-transaction-id', trans.id);
                    itemsRow.innerHTML = `
                        <td colspan="4" class="p-3 bg-light">
                            <table class="table table-sm table-bordered mb-0">
                                <thead class="table-danger">
                                    <tr>
                                        <th>Description</th>
                                        <th>Qty</th>
                                        <th>Unit</th>
                                        <th class="text-end">Unit Price</th>
                                        <th class="text-end">Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${trans.items.map(item => `
                                        <tr>
                                            <td>${item.description || ''}</td>
                                            <td>${parseFloat(item.qty || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                            <td>${item.unit || ''}</td>
                                            <td class="text-end">${formatAmount(item.unit_price || 0)}</td>
                                            <td class="text-end fw-bold">${formatAmount(item.amount || 0)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </td>
                    `;
                    tbody.appendChild(itemsRow);
                }
                
                // Add expandable wage entries row for Wages
                if (type === 'Wages' && trans.wageEntries && trans.wageEntries.length > 0) {
                    const itemsRow = document.createElement('tr');
                    itemsRow.className = 'wages-items-row';
                    itemsRow.style.display = 'none';
                    itemsRow.setAttribute('data-transaction-id', trans.id);
                    itemsRow.innerHTML = `
                        <td colspan="4" class="p-3 bg-light">
                            <table class="table table-sm table-bordered mb-0">
                                <thead class="table-danger">
                                    <tr>
                                        <th>Employee</th>
                                        <th class="text-end">Rate/Day</th>
                                        <th class="text-end">Days</th>
                                        <th class="text-end">Overtime Hours</th>
                                        <th class="text-end">Overtime Amount</th>
                                        <th class="text-end">Total Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${trans.wageEntries.map(entry => `
                                        <tr>
                                            <td>${entry.employeeName || ''}</td>
                                            <td class="text-end">${formatAmount(entry.ratePerDay || 0)}</td>
                                            <td class="text-end">${parseFloat(entry.days || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                            <td class="text-end">${parseFloat(entry.overtimeHours || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                                            <td class="text-end">${formatAmount(entry.overtimeAmount || 0)}</td>
                                            <td class="text-end fw-bold">${formatAmount(entry.totalAmount || 0)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </td>
                    `;
                    tbody.appendChild(itemsRow);
                }
            });
            
            // Add click handlers for expandable Purchases rows
            document.querySelectorAll('.purchases-expandable').forEach(row => {
                row.addEventListener('click', function(e) {
                    // Don't expand if clicking on buttons
                    if (e.target.closest('button')) {
                        return;
                    }
                    
                    const transactionId = this.getAttribute('data-transaction-id');
                    const itemsRow = document.querySelector(`.purchases-items-row[data-transaction-id="${transactionId}"]`);
                    const chevron = this.querySelector('.bi-chevron-down, .bi-chevron-up');
                    
                    if (itemsRow) {
                        if (itemsRow.style.display === 'none') {
                            itemsRow.style.display = '';
                            if (chevron) {
                                chevron.classList.remove('bi-chevron-down');
                                chevron.classList.add('bi-chevron-up');
                            }
                        } else {
                            itemsRow.style.display = 'none';
                            if (chevron) {
                                chevron.classList.remove('bi-chevron-up');
                                chevron.classList.add('bi-chevron-down');
                            }
                        }
                    }
                });
            });
            
            // Add click handlers for expandable Wages rows
            document.querySelectorAll('.wages-expandable').forEach(row => {
                row.addEventListener('click', function(e) {
                    // Don't expand if clicking on buttons
                    if (e.target.closest('button')) {
                        return;
                    }
                    
                    const transactionId = this.getAttribute('data-transaction-id');
                    const itemsRow = document.querySelector(`.wages-items-row[data-transaction-id="${transactionId}"]`);
                    const chevron = this.querySelector('.bi-chevron-down, .bi-chevron-up');
                    
                    if (itemsRow) {
                        if (itemsRow.style.display === 'none') {
                            itemsRow.style.display = '';
                            if (chevron) {
                                chevron.classList.remove('bi-chevron-down');
                                chevron.classList.add('bi-chevron-up');
                            }
                        } else {
                            itemsRow.style.display = 'none';
                            if (chevron) {
                                chevron.classList.remove('bi-chevron-up');
                                chevron.classList.add('bi-chevron-down');
                            }
                        }
                    }
                });
            });

            // Add edit event listeners
            document.querySelectorAll('.edit-transaction').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    const transaction = transactions.find(t => t.id === id);
                    if (transaction) {
                        editingTransactionId = id;
                        document.getElementById('editDate').value = transaction.date;
                        document.getElementById('editTransactionType').value = transaction.transactionType;
                        document.getElementById('editAmount').value = transaction.amount;
                        new bootstrap.Modal(document.getElementById('editTransactionModal')).show();
                    }
                });
            });

            // Add delete event listeners
            document.querySelectorAll('.delete-transaction').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (confirm('Are you sure you want to delete this transaction?')) {
                        const id = parseInt(this.getAttribute('data-id'));
                        transactions = transactions.filter(t => t.id !== id);
                        recalculateCashOnHand();
                        updateTransactionsTable();
                        updateSummaryPanels();
                    }
                });
            });
        }

        // Handle form reset
        document.getElementById('clearFormBtn').addEventListener('click', function() {
            const transactionType = document.getElementById('transactionType').value;
            if (transactionType === 'Wages') {
                // For Wages, just clear input fields but keep entries
                document.getElementById('wagesEmployee').value = '';
                document.getElementById('wagesRatePerDay').value = '';
                document.getElementById('wagesDays').value = '';
                document.getElementById('wagesOvertimeHours').value = '';
                document.getElementById('wagesOvertimeAmount').value = '';
                document.getElementById('wagesTotalAmount').value = '';
            } else {
                document.getElementById('wagesFields').style.display = 'none';
                document.getElementById('amount').readOnly = false;
                document.getElementById('wagesEmployee').value = '';
                document.getElementById('wagesRatePerDay').value = '';
                document.getElementById('wagesDays').value = '';
                document.getElementById('wagesOvertimeHours').value = '';
                document.getElementById('wagesOvertimeAmount').value = '';
                document.getElementById('wagesTotalAmount').value = '';
            }
            // Note: wagesEntries are NOT cleared on form reset - they persist until Submit Transaction
        });

        // Handle Submit Transaction button
        document.getElementById('submitTransactionsBtn').addEventListener('click', async function() {
            if (transactions.length === 0) {
                alert('No transactions to submit.');
                return;
            }

            // Collect all wages entries from all Wages transactions
            const allWagesEntries = [];
            const wagesTransactions = transactions.filter(t => t.transactionType === 'Wages');
            
            if (wagesTransactions.length > 0 && wagesEntries.length > 0) {
                // Get the date from the first Wages transaction
                const wagesDate = wagesTransactions[0].date;
                
                // Save wages entries to backend
                try {
                    const wagesResp = await fetch('{{ url_for("carenderia.save_wages") }}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            date: wagesDate,
                            entries: wagesEntries
                        })
                    });
                    const wagesData = await wagesResp.json();
                    if (!wagesResp.ok || !wagesData.success) {
                        alert(wagesData.error || 'Failed to save wages.');
                        return;
                    }
                } catch (error) {
                    console.error(error);
                    alert('Error saving wages. Please try again.');
                    return;
                }
            }

            if (!confirm(`Are you sure you want to submit ${transactions.length} transaction(s) to the database?`)) {
                return;
            }

            try {
                const resp = await fetch('{{ url_for("carenderia.save_transactions") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        transactions: transactions
                    })
                });
                const data = await resp.json();
                
                if (resp.ok && data.success) {
                    alert(data.message || 'Transactions saved successfully!');
                    // Clear transactions and wages entries after successful save
                    transactions = [];
                    wagesEntries = [];
                    updateTransactionsTable();
                    updateWagesEntriesTable();
                    updateSummaryPanels();
                } else {
                    alert(data.error || 'Failed to save transactions.');
                }
            } catch (error) {
                console.error(error);
                alert('Error saving transactions. Please try again.');
            }
        });

        // Initialize
        updateSummaryPanels();
        
        // Load employees on page load
        loadCarenderiaEmployees();

        // Manage Daily Expense Modal - Initialize after DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            const manageDailyExpenseModal = document.getElementById('manageDailyExpenseModal');
            if (!manageDailyExpenseModal) {
                console.error('manageDailyExpenseModal not found');
                return;
            }

            let dailyExpenses = [];

            async function loadDailyExpenses() {
                try {
                    const tbody = document.getElementById('dailyExpensesTableBody');
                    if (tbody) {
                        tbody.innerHTML = '<tr><td colspan="2" class="text-center">Loading...</td></tr>';
                    }
                    
                    const url = '{{ url_for("carenderia.get_daily_expenses") }}';
                    console.log('Fetching daily expenses from:', url);
                    
                    const response = await fetch(url);
                    console.log('Response status:', response.status);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Response error:', errorText);
                        throw new Error(`HTTP error! status: ${response.status}, body: ${errorText}`);
                    }
                    
                    const data = await response.json();
                    console.log('Daily expenses response:', data);
                    
                    if (data.success && data.expenses) {
                        dailyExpenses = data.expenses;
                        console.log('Loaded', dailyExpenses.length, 'expenses');
                        renderDailyExpensesTable();
                    } else {
                        console.error('Failed to load expenses:', data);
                        if (tbody) {
                            tbody.innerHTML = '<tr><td colspan="2" class="text-center text-danger">Error: ' + (data.message || 'Failed to load expenses') + '</td></tr>';
                        }
                    }
                } catch (error) {
                    console.error('Error loading daily expenses:', error);
                    const tbody = document.getElementById('dailyExpensesTableBody');
                    if (tbody) {
                        tbody.innerHTML = '<tr><td colspan="2" class="text-center text-danger">Error loading expenses: ' + error.message + '</td></tr>';
                    }
                }
            }

            function renderDailyExpensesTable() {
                const tbody = document.getElementById('dailyExpensesTableBody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                if (dailyExpenses.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="2" class="text-center text-muted">No expenses found.</td></tr>';
                    return;
                }
                
                dailyExpenses.forEach(expense => {
                    const row = document.createElement('tr');
                    row.style.cursor = 'pointer';
                    row.onclick = () => editDailyExpense(expense);
                    row.innerHTML = `
                        <td>${expense.expense_type}</td>
                        <td class="text-end">${parseFloat(expense.amount || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    `;
                    tbody.appendChild(row);
                });
            }

            function editDailyExpense(expense) {
                const editExpenseId = document.getElementById('editExpenseId');
                const editExpenseType = document.getElementById('editExpenseType');
                const editExpenseAmount = document.getElementById('editExpenseAmount');
                
                if (editExpenseId) editExpenseId.value = expense.id;
                if (editExpenseType) editExpenseType.value = expense.expense_type;
                if (editExpenseAmount) editExpenseAmount.value = expense.amount || 0;
                
                const editModalEl = document.getElementById('editDailyExpenseModal');
                if (editModalEl) {
                    const editModal = new bootstrap.Modal(editModalEl);
                    editModal.show();
                }
            }

            // Load expenses when modal is shown
            manageDailyExpenseModal.addEventListener('show.bs.modal', function() {
                loadDailyExpenses();
            });

            // Save expense button
            const saveExpenseBtn = document.getElementById('saveExpenseBtn');
            if (saveExpenseBtn) {
                saveExpenseBtn.addEventListener('click', async function() {
                    const expenseId = document.getElementById('editExpenseId').value;
                    const amount = parseFloat(document.getElementById('editExpenseAmount').value) || 0;
                    
                    try {
                        const response = await fetch(`{{ url_for("carenderia.update_daily_expense", expense_id=0) }}`.replace('/0', `/${expenseId}`), {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ amount: amount })
                        });
                        
                        const data = await response.json();
                        if (data.success) {
                            bootstrap.Modal.getInstance(document.getElementById('editDailyExpenseModal')).hide();
                            await loadDailyExpenses();
                            alert('Expense updated successfully!');
                        } else {
                            alert(data.message || 'Failed to update expense.');
                        }
                    } catch (error) {
                        console.error('Error updating expense:', error);
                        alert('Error updating expense. Please try again.');
                    }
                });
            }

            // Open Add Expense modal from Manage modal
            const openAddExpenseBtn = document.getElementById('openAddExpenseBtn');
            console.log('openAddExpenseBtn found:', !!openAddExpenseBtn);
            if (openAddExpenseBtn) {
                openAddExpenseBtn.addEventListener('click', function(e) {
                    console.log('+ Add Expense button clicked');
                    e.preventDefault();
                    e.stopPropagation();
                    bootstrap.Modal.getInstance(manageDailyExpenseModal).hide();
                    setTimeout(() => {
                        const addModalEl = document.getElementById('addDailyExpenseModal');
                        console.log('addDailyExpenseModal found:', !!addModalEl);
                        if (addModalEl) {
                            const addModal = new bootstrap.Modal(addModalEl);
                            addModal.show();
                        } else {
                            alert('Add Expense modal not found. Please refresh the page.');
                        }
                    }, 300);
                });
            } else {
                console.error('openAddExpenseBtn not found in DOM');
            }

            // Cancel Add Expense - return to Manage modal
            const cancelAddExpenseBtn = document.getElementById('cancelAddExpenseBtn');
            if (cancelAddExpenseBtn) {
                cancelAddExpenseBtn.addEventListener('click', function() {
                    bootstrap.Modal.getInstance(document.getElementById('addDailyExpenseModal')).hide();
                    setTimeout(() => {
                        const manageModal = new bootstrap.Modal(manageDailyExpenseModal);
                        manageModal.show();
                    }, 300);
                });
            }

            // Add new expense
            const addExpenseBtn = document.getElementById('addExpenseBtn');
            console.log('addExpenseBtn found:', !!addExpenseBtn);
            if (addExpenseBtn) {
                addExpenseBtn.addEventListener('click', async function(e) {
                    console.log('Add Expense button clicked');
                    e.preventDefault();
                    e.stopPropagation();
                    const expenseType = document.getElementById('addExpenseType');
                    const expenseAmount = document.getElementById('addExpenseAmount');
                    
                    if (!expenseType || !expenseAmount) {
                        alert('Form elements not found.');
                        return;
                    }
                    
                    const typeValue = expenseType.value.trim();
                    const amountValue = parseFloat(expenseAmount.value) || 0;
                    
                    if (!typeValue) {
                        alert('Please enter an expense type.');
                        return;
                    }
                    
                    try {
                        const response = await fetch('{{ url_for("carenderia.add_daily_expense") }}', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ 
                                expense_type: typeValue,
                                amount: amountValue 
                            })
                        });
                        
                        const data = await response.json();
                        if (data.success) {
                            bootstrap.Modal.getInstance(document.getElementById('addDailyExpenseModal')).hide();
                            // Clear form
                            expenseType.value = '';
                            expenseAmount.value = '0';
                            // Reload expenses list
                            await loadDailyExpenses();
                            // Reopen manage modal
                            setTimeout(() => {
                                const manageModal = new bootstrap.Modal(manageDailyExpenseModal);
                                manageModal.show();
                            }, 300);
                            alert('Expense added successfully!');
                        } else {
                            alert(data.message || 'Failed to add expense.');
                        }
                    } catch (error) {
                        console.error('Error adding expense:', error);
                        alert('Error adding expense. Please try again.');
                    }
                });
            }
        });
    </script>
    {% endblock %}

    <!-- Manage Daily Expense Modal -->
    <div class="modal fade" id="manageDailyExpenseModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Manage Daily Expense</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted">Click on an expense row to edit its amount.</p>
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Expense Type</th>
                                    <th class="text-end">Amount (â‚±)</th>
                                </tr>
                            </thead>
                            <tbody id="dailyExpensesTableBody">
                                <tr>
                                    <td colspan="2" class="text-center">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="openAddExpenseBtn">+ Add Expense</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Daily Expense Modal -->
    <div class="modal fade" id="addDailyExpenseModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Add New Expense</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Expense Type</label>
                        <input type="text" class="form-control" id="addExpenseType" placeholder="e.g., Internet Bill" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Amount (â‚±)</label>
                        <input type="number" step="0.01" min="0" class="form-control" id="addExpenseAmount" value="0" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="cancelAddExpenseBtn">Cancel</button>
                    <button type="button" class="btn btn-danger" id="addExpenseBtn">Add Expense</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Daily Expense Modal -->
    <div class="modal fade" id="editDailyExpenseModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Edit Daily Expense</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editExpenseId">
                    <div class="mb-3">
                        <label class="form-label">Expense Type</label>
                        <input type="text" class="form-control" id="editExpenseType" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Amount (â‚±)</label>
                        <input type="number" step="0.01" min="0" class="form-control" id="editExpenseAmount" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="saveExpenseBtn">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

</body>
</html>
