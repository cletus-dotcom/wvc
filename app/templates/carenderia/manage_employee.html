<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Employees - Carenderia</title>
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-4">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-start mb-3">
        <div>
            <a href="{{ url_for('carenderia.carenderia_home') }}" class="btn btn-secondary btn-sm mb-1">&larr; Back</a>
            <h3 class="mb-1">Manage Employees</h3>
        </div>

        <button class="btn btn-success btn-sm mt-2" data-bs-toggle="modal" data-bs-target="#addEmployeeModal">
            + Add Employee
        </button>
    </div>

    <!-- Search Bar -->
    <div class="mb-3">
        <label for="searchEmployee" class="form-label">Search Employee</label>
        <input type="text" id="searchEmployee" class="form-control" placeholder="Type a name..." list="employeeNames">
        <datalist id="employeeNames"></datalist>
    </div>


    <!-- Employee Table -->
    <div class="card shadow-sm">
        <div class="card-body">
            <table class="table table-bordered table-sm align-middle" id="employeeTable">
                <thead class="table-light">
                    <tr>
                        <th style="width:40px;">ID</th>
                        <th>Name</th>
                        <th>Role</th>
                        <th>Rate/Day</th>
                        <th>Department</th>
                        <th style="width: 150px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                {% for emp in employees %}
                    <tr id="empRow{{ emp.id }}">
                        <td>{{ emp.id }}</td>
                        <td>{{ emp.name }}</td>
                        <td>{{ emp.role }}</td>
                        <td>{{ "{:,.2f}".format(emp.rate_per_day) if emp.rate_per_day else "" }}</td>
                        <td>{{ emp.department.name if emp.department else "" }}</td>
                        <td>
                            <button class="btn btn-warning btn-sm edit-btn"
                                    data-id="{{ emp.id }}"
                                    data-name="{{ emp.name }}"
                                    data-role="{{ emp.role }}"
                                    data-rate="{{ emp.rate_per_day or '' }}"
                                    data-department="{{ emp.department_id }}">
                                Edit
                            </button>
                            <a href="{{ url_for('carenderia.delete_employee', emp_id=emp.id) }}"
                               class="btn btn-danger btn-sm delete-btn"
                               onclick="return confirm('Are you sure you want to delete this employee?');">
                                Delete
                            </a>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Add Employee Modal -->
    <div class="modal fade" id="addEmployeeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="addEmployeeForm">
                    <div class="modal-header">
                        <h5 class="modal-title">Add Employee</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">

                        <div class="mb-3">
                            <label class="form-label">Full Name</label>
                            <input type="text" name="name" class="form-control" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Department</label>
                            <select name="department_id" class="form-select" id="addDepartment" required>
                                <option value="">Select Department</option>
                                {% for dept in departments %}
                                    <option value="{{ dept.id }}">{{ dept.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Role</label>
                            <select name="role" class="form-select" id="addRole" required>
                                <option value="">Select Role</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Rate per Day</label>
                            <input type="number" step="0.01" name="rate_per_day" class="form-control">
                        </div>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success btn-sm">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Employee Modal -->
    <div class="modal fade" id="editEmployeeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="POST" id="editEmployeeForm">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit Employee</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">

                        <div class="mb-3">
                            <label class="form-label">Full Name</label>
                            <input type="text" name="name" class="form-control" id="editName" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Department</label>
                            <select name="department_id" class="form-select" id="editDepartment" required>
                                {% for dept in departments %}
                                    <option value="{{ dept.id }}">{{ dept.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Role</label>
                            <select name="role" class="form-select" id="editRole" required>
                                <option value="">Select Role</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Rate per Day</label>
                            <input type="number" step="0.01" name="rate_per_day" class="form-control" id="editRate">
                        </div>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success btn-sm">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

</div>

<script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
<script>
    // ===================== Department Roles =====================
    const departmentRoles = {
        "Construction": ["Laborer", "Carpenter", "Asst. Carpenter", "Mason", "Asst. Mason", "Plumber", "Asst. Plumber", "Electrician", "Asst. Electrician", "Driver", "Foreman", "Asst. Foreman"],
        "Carenderia": ["Sales Representative", "Dish Washer", "Chef", "Asst. Chef", "Laborer", "Manager", "Cashier"],
        "Catering": ["Laborer", "Server", "Manager", "Driver"]
    };

    function updateRoleOptions(deptSelect, roleSelect, currentRole="") {
        const selectedDept = deptSelect.options[deptSelect.selectedIndex].text;
        roleSelect.innerHTML = '<option value="">Select Role</option>';
        if(departmentRoles[selectedDept]){
            departmentRoles[selectedDept].forEach(role => {
                const opt = document.createElement('option');
                opt.value = role;
                opt.text = role;
                if(role === currentRole) opt.selected = true;
                roleSelect.appendChild(opt);
            });
        }
    }

    // ===================== Employee Table & Modals =====================
    const employeeTable = document.querySelector('#employeeTable tbody');

    const addForm = document.getElementById('addEmployeeForm');
    const addDept = document.getElementById('addDepartment');
    const addRole = document.getElementById('addRole');

    const editForm = document.getElementById('editEmployeeForm');
    const editName = document.getElementById('editName');
    const editDept = document.getElementById('editDepartment');
    const editRole = document.getElementById('editRole');
    const editRate = document.getElementById('editRate');

    addDept.addEventListener('change', () => updateRoleOptions(addDept, addRole));
    editDept.addEventListener('change', () => updateRoleOptions(editDept, editRole));

    // ---------- Add Employee ----------
    addForm.addEventListener('submit', e => {
        e.preventDefault();
        const formData = new FormData(addForm);

        fetch('{{ url_for("carenderia.add_employee") }}', {
            method: 'POST',
            headers: {'X-Requested-With': 'XMLHttpRequest'},
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if(data.success){
                addOrUpdateRow(data.employee);
                addForm.reset();
                addRole.innerHTML = '<option value="">Select Role</option>';
                bootstrap.Modal.getInstance(document.getElementById('addEmployeeModal')).hide();
                updateSearchDatalist(); // refresh autocomplete
            } else alert(data.error || 'Failed to add employee.');
        });
    });

    // ---------- Edit Employee ----------
    employeeTable.parentElement.addEventListener('click', e => {
        if(e.target.classList.contains('edit-btn')){
            const btn = e.target;
            editForm.action = `/carenderia/edit-employee/${btn.dataset.id}`;
            editName.value = btn.dataset.name;
            editRate.value = btn.dataset.rate;
            editDept.value = btn.dataset.department;
            updateRoleOptions(editDept, editRole, btn.dataset.role);
            new bootstrap.Modal(document.getElementById('editEmployeeModal')).show();
        }
    });

    editForm.addEventListener('submit', e => {
        e.preventDefault();
        const empId = editForm.action.split('/').pop();
        const formData = new FormData(editForm);

        fetch(editForm.action, {
            method: 'POST',
            headers: {'X-Requested-With': 'XMLHttpRequest'},
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if(data.success){
                addOrUpdateRow(data.employee);
                bootstrap.Modal.getInstance(document.getElementById('editEmployeeModal')).hide();
                updateSearchDatalist(); // refresh autocomplete
            } else alert(data.error || 'Failed to update employee.');
        });
    });

    // ---------- Add/Update Table Row ----------
    function addOrUpdateRow(emp){
        let row = document.getElementById(`empRow${emp.id}`);
        if(!row){
            row = document.createElement('tr');
            row.id = `empRow${emp.id}`;
            employeeTable.appendChild(row);
        }
        const rateDisplay = emp.rate_per_day ? parseFloat(emp.rate_per_day).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '';
        row.innerHTML = `
            <td>${emp.id}</td>
            <td>${emp.name}</td>
            <td>${emp.role}</td>
            <td>${rateDisplay}</td>
            <td>${emp.department_name || ''}</td>
            <td>
                <button class="btn btn-warning btn-sm edit-btn"
                        data-id="${emp.id}"
                        data-name="${emp.name}"
                        data-role="${emp.role}"
                        data-rate="${emp.rate_per_day || ''}"
                        data-department="${emp.department_id}">
                    Edit
                </button>
                <a href="/carenderia/delete-employee/${emp.id}" class="btn btn-danger btn-sm delete-btn" onclick="return confirm('Are you sure?');">Delete</a>
            </td>
        `;
    }

    // ===================== Employee Name Search =====================
    const searchInput = document.getElementById('searchEmployee');
    const dataList = document.getElementById('employeeNames');

    function updateSearchDatalist(){
        fetch('{{ url_for("carenderia.employee_names") }}')
        .then(res => res.json())
        .then(data => {
            dataList.innerHTML = '';
            data.names.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                dataList.appendChild(option);
            });
        });
    }

    // ===================== Live Table Filter =====================
    searchInput.addEventListener('input', function(){
        const query = this.value.toLowerCase();

        // Loop through all table rows
        employeeTable.querySelectorAll('tr').forEach(row => {
            const nameCell = row.children[1].textContent.toLowerCase();
            if(nameCell.includes(query)){
                row.style.display = '';  // show row
            } else {
                row.style.display = 'none';  // hide row
            }
        });
    });


    // Initial load
    updateSearchDatalist();
</script>


</body>
</html>
