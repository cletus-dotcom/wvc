<!DOCTYPE html>
<html>
<head>
    <title>Update Project</title>
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">

    <style>
        tr.project-row:hover {
            background: #eef2ff;
            cursor: pointer;
        }
    </style>
</head>

<body class="bg-light p-4">

<div class="container">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0">Update Project</h2>
        <a href="{{ url_for('construction.construction_home') }}" class="btn btn-secondary">
            ‚¨Ö Back to Home
        </a>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for cat, msg in messages %}
            <div class="alert alert-{{ cat }}">{{ msg }}</div>
        {% endfor %}
    {% endif %}
    {% endwith %}

    <!-- Search Bar -->
    <div class="input-group mb-3">
        <input id="searchBox" type="text" class="form-control" placeholder="Search project...">
        <span class="input-group-text">üîç</span>
    </div>

    <!-- Table -->
    <table id="projectTable" class="table table-bordered bg-white shadow-sm">
        <thead class="table-dark">
            <tr>
                <th>Project Name</th>
                <th>Contractor</th>
                <th>Duration (days)</th>
                <th>Status</th>
            </tr>
        </thead>

        <tbody>
        {% for p in projects %}
            <tr class="project-row"
                data-id="{{ p.id }}"
                data-name="{{ p.project_name }}"
                data-contractor="{{ p.contractor_name }}"
                data-site="{{ p.project_site }}"
                data-ntp="{{ p.ntp_date }}"
                data-complete="{{ p.completion_date }}"
                data-duration="{{ p.contract_duration }}"
                data-price="{{ p.contract_price }}"
                data-status="{{ p.status }}">

                <td>{{ p.project_name }}</td>
                <td>{{ p.contractor_name }}</td>
                <td>{{ p.contract_duration }}</td>
                <td>{{ p.status }}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <!-- Pagination -->
    <nav>
        <ul class="pagination" id="pagination"></ul>
    </nav>

</div>


<!-- ‚≠ê REUSABLE EDIT MODAL -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <form method="POST" id="editForm" class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Edit Project</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body row g-3">

                <div class="col-md-6">
                    <label>Project Name</label>
                    <input name="project_name" id="edit_project_name" class="form-control">
                </div>

                <div class="col-md-6">
                    <label>Contractor Name</label>
                    <input name="contractor_name" id="edit_contractor_name" class="form-control">
                </div>

                <div class="col-md-12">
                    <label>Project Site</label>
                    <textarea name="project_site" id="edit_project_site" class="form-control"></textarea>
                </div>

                <div class="col-md-6">
                    <label>NTP Date</label>
                    <input type="date" name="ntp_date" id="edit_ntp_date" class="form-control">
                </div>

                <div class="col-md-6">
                    <label>Completion Date</label>
                    <input type="date" name="completion_date" id="edit_completion_date" class="form-control">
                </div>

                <div class="col-md-4">
                    <label>Duration (days)</label>
                    <input type="number" name="contract_duration" id="edit_duration" class="form-control">
                </div>

                <div class="col-md-4">
                    <label>Contract Price</label>
                    <input type="number" step="0.01" name="contract_price" id="edit_price" class="form-control">
                </div>

                <div class="col-md-4">
                    <label>Status</label>
                    <select name="status" id="edit_status" class="form-control">
                        <option value="planning">Planning</option>
                        <option value="ongoing">Ongoing</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>

            </div>

            <div class="modal-footer d-flex justify-content-between">
                <button id="deleteBtn" type="button" class="btn btn-danger">Delete</button>
                <button class="btn btn-primary">Update</button>
            </div>

        </form>
    </div>
</div>


<!-- ‚≠ê REUSABLE DELETE MODAL -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <form method="POST" id="deleteForm" class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Delete Project?</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                Are you sure you want to delete <b id="deleteProjectName"></b>?
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button class="btn btn-danger">Delete</button>
            </div>

        </form>
    </div>
</div>


<script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>

<script>
/* Bootstrap modal instances */
const editModal = new bootstrap.Modal(document.getElementById("editModal"));
const deleteModal = new bootstrap.Modal(document.getElementById("deleteModal"));

/* SEARCH FUNCTION */
document.getElementById("searchBox").addEventListener("keyup", function () {
    let filter = this.value.toLowerCase();
    let rows = document.querySelectorAll("#projectTable tbody tr");

    rows.forEach(r => {
        let text = r.innerText.toLowerCase();
        r.style.display = text.includes(filter) ? "" : "none";
    });
});

/* PAGINATION */
const rowsPerPage = 8;
const table = document.getElementById("projectTable");
const rows = table.querySelectorAll("tbody tr");
const pagination = document.getElementById("pagination");
const totalPages = Math.ceil(rows.length / rowsPerPage);

function showPage(page) {
    rows.forEach((row, i) => {
        row.style.display = (i >= (page - 1) * rowsPerPage && i < page * rowsPerPage)
            ? ""
            : "none";
    });
}

for (let i = 1; i <= totalPages; i++) {
    let li = document.createElement("li");
    li.className = "page-item";
    li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
    li.onclick = () => showPage(i);
    pagination.appendChild(li);
}

showPage(1);

/* LOAD EDIT MODAL */
document.querySelectorAll(".project-row").forEach(row => {
    row.addEventListener("click", () => {

        let id = row.dataset.id;

        edit_project_name.value = row.dataset.name;
        edit_contractor_name.value = row.dataset.contractor;
        edit_project_site.value = row.dataset.site;
        edit_ntp_date.value = row.dataset.ntp;
        edit_completion_date.value = row.dataset.complete;
        edit_duration.value = row.dataset.duration;
        edit_price.value = row.dataset.price;
        edit_status.value = row.dataset.status;

        // FIX: Use hyphen URLs
        editForm.action = `/construction/update-project/${id}`;
        deleteForm.action = `/construction/delete-project/${id}`;

        deleteProjectName.innerText = row.dataset.name;

        editModal.show();
    });
});


/* DELETE BUTTON */
deleteBtn.addEventListener("click", () => {
    editModal.hide();
    deleteModal.show();
});
</script>


</body>
</html>
