<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Balance Sheet - Construction</title>
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/mobile-friendly.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container container-mobile mt-4 py-3">
    <div class="d-flex page-header-mobile flex-wrap justify-content-between align-items-start mb-3 gap-2">
        <div>
            <a href="{{ url_for('construction.construction_home') }}" class="btn btn-secondary btn-sm mb-1">&larr; Back</a>
            <h3 class="mb-1">Balance Sheet</h3>
        </div>
        <div>
            <a class="btn btn-danger btn-sm" target="_blank"
               href="{{ url_for('construction.export_balance_sheet_pdf', project_id=(selected_project.id if selected_project else '') ) }}">
                <i class="bi bi-file-pdf"></i> Export PDF
            </a>
        </div>
    </div>

    <!-- Project Filter -->
    <div class="card shadow-sm mb-3">
        <div class="card-body">
            <form method="GET" action="{{ url_for('construction.view_balance_sheet') }}" class="row g-3 align-items-end">
                <div class="col-md-6">
                    <label class="form-label fw-bold">Project</label>
                    <select class="form-select" name="project_id" onchange="this.form.submit()">
                        <option value="">All Projects</option>
                        {% for p in projects %}
                            <option value="{{ p.id }}" {% if selected_project and selected_project.id == p.id %}selected{% endif %}>
                                {{ p.project_name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary">Filter</button>
                </div>
                {% if selected_project %}
                <div class="col-md-4 text-end">
                    <a href="{{ url_for('construction.view_balance_sheet') }}" class="btn btn-secondary btn-sm">Clear Filter</a>
                </div>
                {% endif %}
            </form>
        </div>
    </div>

    <!-- Summary -->
    <div class="card shadow-sm mb-3">
        <div class="card-header bg-primary text-white">
            Summary
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="p-3 border rounded bg-white">
                        <div class="text-muted small">Total Contract Amount</div>
                        <div class="fw-bold">{{ "{:,.2f}".format(summary.overall_contract_total) }}</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="p-3 border rounded bg-white">
                        <div class="text-muted small">Total Expenses</div>
                        <div class="fw-bold">{{ "{:,.2f}".format(summary.overall_expense_total) }}</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="p-3 border rounded bg-white">
                        <div class="text-muted small">Balance</div>
                        <div class="fw-bold {% if summary.overall_balance < 0 %}text-danger{% else %}text-success{% endif %}">
                            {{ "{:,.2f}".format(summary.overall_balance) }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Per Project Details -->
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            Per Project Details
        </div>
        <div class="card-body">
            {% if per_project_rows %}
            <div class="table-responsive table-responsive-mobile">
                <table class="table table-bordered table-sm align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Project</th>
                            <th class="text-end">Contract</th>
                            <th class="text-end">Materials</th>
                            <th class="text-end">Labor</th>
                            <th class="text-end">Gasoline</th>
                            <th class="text-end">Documents</th>
                            <th class="text-end">Obligation</th>
                            <th class="text-end">Total Exp.</th>
                            <th class="text-end">Balance</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in per_project_rows %}
                        <tr>
                            <td>
                                <a href="{{ url_for('construction.project_overview', project_id=row.project.id) }}">
                                    {{ row.project.project_name }}
                                </a>
                            </td>
                            <td class="text-end">{{ "{:,.2f}".format(row.contract_price) }}</td>
                            <td class="text-end">{{ "{:,.2f}".format(row.totals["Materials"]) }}</td>
                            <td class="text-end">{{ "{:,.2f}".format(row.totals["Labor"]) }}</td>
                            <td class="text-end">{{ "{:,.2f}".format(row.totals["Gasoline"]) }}</td>
                            <td class="text-end">{{ "{:,.2f}".format(row.totals["Documents"]) }}</td>
                            <td class="text-end">{{ "{:,.2f}".format(row.totals["Obligation"]) }}</td>
                            <td class="text-end fw-bold">{{ "{:,.2f}".format(row.total_expenses) }}</td>
                            <td class="text-end fw-bold {% if row.balance < 0 %}text-danger{% else %}text-success{% endif %}">
                                {{ "{:,.2f}".format(row.balance) }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info mb-0">No projects found.</div>
            {% endif %}
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
</body>
</html>

